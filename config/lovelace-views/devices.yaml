# ========== TAB 1: DEVICES ==========
- title: Devices
  path: devices
  icon: mdi:power-plug
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: markdown
          content: |
            # üîå Monitored Devices
            Real-time values from automatically discovered **hardware sensors**.
        # --- GLOBAL OVERVIEW ---
        - type: grid
          columns: 2
          square: false
          cards:
            - type: sensor
              entity: sensor.current_consumption
              name: ‚ö° Total Load
              graph: line
            - type: sensor
              entity: sensor.current_hourly_cost
              name: üíµ Hourly Cost
              graph: line
            - type: sensor
              entity: sensor.daily_cost
              name: üí∞ Daily Cost
              graph: line
            - type: sensor
              entity: sensor.daily_co2_estimate
              name: üå± Daily CO2
              graph: line

        # --- DYNAMIC AREA DASHBOARD ---
        - type: vertical-stack
          cards:
            # Filter Input
            - type: entities
              entities:
                - entity: select.dashboard_area_filter
                  name: Filter by Room
                  icon: mdi:filter-variant
              style: |
                ha-card {
                  box-shadow: none;
                  background: none;
                  margin-bottom: -15px;
                }

            - type: markdown
              content: |
                {%- set filter = states('select.dashboard_area_filter') -%}
                {%- set ns = namespace(areas=[]) -%}
                {%- set cats = ['power', 'energy', 'temperature', 'humidity', 'illuminance', 'occupancy'] -%}

                {# --- 1. Collect Unique Areas --- #}
                {%- for c in cats -%}
                  {%- set sensors = state_attr('sensor.hardware_sensors', c) -%}
                  {%- if sensors and sensors is iterable -%}
                    {%- for s in sensors -%}
                      {%- set area = s.get('area', 'Unassigned') -%}
                      {%- if area and area not in ns.areas -%}
                        {%- set ns.areas = ns.areas + [area] -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}
                {%- endfor -%}

                {# --- 2. Render Tables by Area --- #}
                {%- if ns.areas | length == 0 -%}
                  <p style="text-align: center;">‚ö†Ô∏è <b>No sensors or areas detected.</b></p>
                {%- else -%}
                  {%- for area in ns.areas | sort -%}
                    {# Check Filter #}
                    {%- if filter in ['All Areas', 'unknown', 'unavailable', 'None'] or filter == area -%}
                      
                      <h3>üìç {{ area }}</h3>
                      <table width="100%">
                      {%- for c in cats -%}
                        {%- set sensors = state_attr('sensor.hardware_sensors', c) -%}
                        {%- if sensors and sensors is iterable -%}
                          {%- for s in sensors -%}
                            {%- if s.get('area', 'Unassigned') == area -%}
                              <tr>
                                <td width="30px">
                                  <ha-icon icon="{{ 'mdi:lightning-bolt' if c == 'power' else 'mdi:counter' if c == 'energy' else 'mdi:thermometer' if c == 'temperature' else 'mdi:water-percent' if c == 'humidity' else 'mdi:brightness-5' if c == 'illuminance' else 'mdi:eye' }}" style="width: 20px; color: var(--secondary-text-color);"></ha-icon>
                                </td>
                                <td>{{ s.name }}</td>
                                <td align="right">
                                  {%- if c == 'occupancy' -%}
                                    {{ 'üî¥' if s.value == 'on' else 'üü¢' }}
                                  {%- else -%}
                                    <b>{{ s.value }}</b> <small>{{ s.unit }}</small>
                                  {%- endif -%}
                                </td>
                              </tr>
                            {%- endif -%}
                          {%- endfor -%}
                        {%- endif -%}
                      {%- endfor -%}
                      </table>
                      <hr style="border: 0; border-bottom: 1px solid var(--divider-color); margin: 15px 0;">
                      
                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}

        # --- LEGEND ---
        - type: markdown
          content: |
            ### üìò Quick Guide
            {% set p = state_attr('sensor.hardware_sensors', 'power') %}
            {% set e = state_attr('sensor.hardware_sensors', 'energy') %}
            {% set l = state_attr('sensor.hardware_sensors', 'illuminance') %}
            {% set h = state_attr('sensor.hardware_sensors', 'humidity') %}

            {% if p and p | length > 0 %}
            **‚ö° Power (Watts):** *The "Speedometer"*
            > Shows how much electricity you are using **right now**. 
            > *Tip:* If this is high, a "heavy" appliance like the Oven or AC is running.
            
            ---
            {% endif %}

            {% if e and e | length > 0 %}
            **üîã Energy (kWh):** *The "Odometer"*
            > The total amount used over time. This is what shows up on your **Electric Bill**.
            > *Scale:* **1 unit (kWh)** is roughly one full load of laundry.
            
            ---
            {% endif %}

            {% if l and l | length > 0 %}
            **üí° Light (Lux):** *Brightness*
            > Measures how bright the room is.
            > *Scale:* **0** (Pitch Black) ‚Üí **150** (Typical Living Room) ‚Üí **500+** (Bright Office).
            
            ---
            {% endif %}

            {% if h and h | length > 0 %}
            **üíß Humidity:** *Air Moisture*
            > **40-60%** is the "Comfort Zone."
            > *Warning:* Above **70%** feels "muggy" and risks mold; below **30%** feels very dry.
            {% endif %}