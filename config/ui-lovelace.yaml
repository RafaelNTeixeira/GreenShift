title: Green Shift
views:
  # ========== TAB 1: DEVICES ==========
  - title: Devices
    path: devices
    icon: mdi:power-plug
    type: panel
    cards:
      - type: vertical-stack
        cards:
          - type: markdown
            content: |
              # Monitored Devices
              Real-time values from automatically discovered **hardware sensors**.

              ---
              ### üìò Quick Guide
              {%- set p = state_attr('sensor.hardware_sensors', 'power') %}
              {%- set e = state_attr('sensor.hardware_sensors', 'energy') %}
              {%- set l = state_attr('sensor.hardware_sensors', 'illuminance') %}
              {%- set h = state_attr('sensor.hardware_sensors', 'humidity') %}

              {%- if p and p | length > 0 %}
              **‚ö° W (Watts):** *Instant Speed.* 
              Shows how much electricity is flowing right now. Turning on a device makes this number go up immediately.
              {%- endif %}

              {%- if e and e | length > 0 %}
              **üîã kWh (Kilowatt-hours):** *Accumulated Usage.*
              This counts the total volume of energy used over time (what you pay for). 
              *Impact Example:* **1 kWh** is roughly the energy needed to run a **washing machine cycle**.
              {%- endif %}

              {%- if l and l | length > 0 %}
              **üí° Lux:** *Brightness.*
              Measures light intensity. 0 is pitch black, 500 is a bright place.
              {%- endif %}
              
              {%- if h and h | length > 0 %}
              **üíß Humidity (%):** *Moisture.*
              How much water is in the air. 40-60% is usually comfortable.
              {%- endif %}

          # --- GLOBAL OVERVIEW ---
          - type: horizontal-stack
            cards:
              - type: sensor
                entity: sensor.current_consumption
                name: Total Load
                graph: line
              - type: sensor
                entity: sensor.current_hourly_cost
                name: Current Hourly Cost
                graph: line
              - type: sensor
                entity: sensor.daily_cost
                name: Current Daily Cost
                graph: line
              - type: sensor
                entity: sensor.daily_co2_estimate
                name: Current Daily CO2 (kg)
                graph: line

          # --- DYNAMIC AREA DASHBOARD ---
          - type: vertical-stack
            cards:
              - type: markdown
                content: "### üè† Area Snapshot"
              
              # The Dropdown Menu
              - type: entities
                entities:
                  - entity: select.dashboard_area_filter
                    name: Filter by Room
                style: |
                  ha-card {
                    box-shadow: none;
                    background: none;
                    margin-bottom: -20px; /* Pulls the table up closer */
                  }

              # The filtered table
              - type: markdown
                content: >
                  {%- set filter = states('select.dashboard_area_filter') -%}
                  {%- set ns = namespace(areas=[]) -%}

                  {%- for cat in ['power', 'energy', 'temperature', 'humidity', 'illuminance', 'occupancy'] -%}
                    {%- set sensors = state_attr('sensor.hardware_sensors', cat) -%}
                    {%- if sensors -%}
                      {%- for s in sensors -%}
                        {%- set area_name = s.get('area') -%}
                        {%- if area_name and area_name not in ns.areas -%}
                          {%- set ns.areas = ns.areas + [area_name] -%}
                        {%- endif -%}
                      {%- endfor -%}
                    {%- endif -%}
                  {%- endfor -%}

                  {%- if ns.areas | length == 0 -%}
                  ‚ö†Ô∏è **No areas detected.**
                  {%- endif -%}
                  
                  {%- for area in ns.areas | sort -%}
                    {%- if filter in ['All Areas', 'unknown', 'unavailable'] or filter == area -%}
                      <h3>{{ area }}</h3>
                      <table width="100%">
                      {%- for cat in ['power', 'energy', 'temperature', 'humidity', 'illuminance', 'occupancy'] -%}
                        {%- set sensors = state_attr('sensor.hardware_sensors', cat) -%}
                        {%- if sensors -%}
                          {%- for s in sensors -%}
                            {%- if s.get('area') == area -%}
                              <tr>
                                <td width="5%" style="text-align: center;">
                                  <ha-icon icon="{{ 'mdi:lightning-bolt' if cat == 'power' else 'mdi:counter' if cat == 'energy' else 'mdi:thermometer' if cat == 'temperature' else 'mdi:water-percent' if cat == 'humidity' else 'mdi:brightness-5' if cat == 'illuminance' else 'mdi:eye' }}" style="width: 20px; color: var(--secondary-text-color);"></ha-icon>
                                </td>
                                <td style="text-align: left;">{{ s.name }}</td>
                                <td style="text-align: right;">
                                  {%- if cat == 'occupancy' -%}
                                    {{ 'üî¥' if s.value == 'on' else 'üü¢' }}
                                  {%- else -%}
                                    <b>{{ s.value }}</b> <small>{{ s.unit }}</small>
                                  {%- endif -%}
                                </td>
                              </tr>
                            {%- endif -%}
                          {%- endfor -%}
                        {%- endif -%}
                      {%- endfor -%}
                      </table>
                    {%- endif -%}
                  {%- endfor -%}

  # ========== TAB 2: DASHBOARD ==========
  - title: Dashboard
    path: dashboard
    icon: mdi:chart-line
    type: panel
    cards:
      - type: vertical-stack
        cards:
          - type: markdown
            content: |
              # Dashboard 
              Analyze your energy consumption patterns and identify opportunities for savings.

          - type: conditional
            conditions:
              - entity: sensor.research_phase
                state: baseline
            card:
              type: markdown
              content: |
                ## üìä Calibration in Progress
                The system is learning your habits (**{{ state_attr('sensor.research_phase', 'days_remaining') }} days remaining**).

          # --- HISTORY GRAPH ---
          - type: history-graph
            title: Consumption vs Baseline (Last Week)
            hours_to_show: 168
            entities:
              - entity: sensor.current_consumption
                name: Current Consumption
              - entity: sensor.energy_baseline
                name: Baseline
          
          # --- AREA CONSUMPTION TABLE ---
          - type: markdown
            content: |
              ### ‚ö° Energy by Area
              
              {%- set sensors = state_attr('sensor.hardware_sensors', 'energy') -%}
              {%- set ns = namespace(area_sums={}, total=0) -%}

              {%- if sensors -%}
                {%- for s in sensors -%}
                  {%- if s.value is not none -%}
                    {%- set ns.total = ns.total + s.value -%}
                    {%- set area = s.area if s.area else 'No Area' -%}
                    {%- set current = ns.area_sums.get(area, 0) -%}
                    {%- set new_dict = {area: current + s.value} -%}
                    {%- set ns.area_sums = dict(ns.area_sums, **new_dict) -%}
                  {%- endif -%}
                {%- endfor -%}
              {%- endif -%}

              {%- if ns.total == 0 -%}
              No energy data collected yet.
              {%- else -%}
              
              <table width="100%">
                <thead>
                  <tr>
                    <th style="text-align: left;">Area</th>
                    <th style="text-align: right;">Usage</th>
                    <th style="text-align: right;">Share</th>
                    <th style="text-align: left;">Distribution</th>
                  </tr>
                </thead>
                <tbody>
                {%- for area, kwh in ns.area_sums.items() | sort(attribute='1', reverse=True) -%}
                  {%- set pct = (kwh / ns.total * 100) | round(0) | int -%}
                  {%- set blocks = (pct / 10) | round(0) | int -%}
                  {%- set bar = '‚ñì' * blocks + '‚ñë' * (10 - blocks) -%}
                  <tr>
                    <td style="text-align: left;"><b>{{ area }}</b></td>
                    <td style="text-align: right;">{{ kwh | round(2) }} kWh</td>
                    <td style="text-align: right;">{{ pct }}%</td>
                    <td style="text-align: left; color: var(--primary-color);">{{ bar }}</td>
                  </tr>
                {%- endfor -%}
                </tbody>
              </table>
              {%- endif -%}

          # --- TOP 5 POWER CONSUMERS ---
          - type: markdown
            content: |
              ### üèÜ Top 5 Power Consumers
              {%- set sensors = state_attr('sensor.hardware_sensors', 'power') -%}
              {%- if sensors -%}
              {# 1. Filter valid sensors and sort by highest Watts first #}
              {%- set top_devices = sensors
                  | selectattr('value', 'ne', None)
                  | sort(attribute='value', reverse=True)
                  | list
              -%}
              {# 2. Get the max value to scale the bars relative to the biggest hog #}
              {%- set max_val = top_devices[0].value if top_devices else 1 -%}

              <table width="100%">
                <thead>
                  <tr>
                    <th style="text-align: left;">Device</th>
                    <th style="text-align: right;">Load</th>
                    <th style="text-align: left; padding-left: 10px;">Impact</th>
                  </tr>
                </thead>
                <tbody>
                  {%- for s in top_devices[:5] -%}
                  {%- set pct = (s.value / max_val * 100) | int -%}
                  {%- set blocks = (pct / 10) | round(0) | int -%}
                  {%- set bar = '‚ñà' * blocks + '‚ñë' * (10 - blocks) -%}
                  <tr>
                    <td style="text-align: left;">{{ s.name }}</td>
                    <td style="text-align: right;"><b>{{ s.value }} W</b></td>
                    <td style="text-align: left; padding-left: 10px; color: var(--primary-color);">
                      {{ bar }}
                    </td>
                  </tr>
                  {%- endfor -%}
                </tbody>
              </table>
              {%- else -%}
              No active devices detected.
              {%- endif -%}


  # ========== TAB 3: CHALLENGES ==========
  - title: Challenges
    path: tasks
    icon: mdi:clipboard-check
    type: panel
    cards:
      - type: vertical-stack
        cards:
          - type: conditional
            conditions:
              - entity: sensor.research_phase
                state: baseline
            card:
              type: markdown
              content: |
                ## üîí Challenges Locked
                **{{ state_attr('sensor.research_phase', 'days_remaining') }} days** until unlock

          - type: conditional
            conditions:
              - entity: sensor.research_phase
                state: active
            card:
              type: vertical-stack
              cards:
                - type: markdown
                  content: |
                    # üìÖ Daily Energy Challenges
                    {% set verified = state_attr('sensor.daily_tasks', 'verified_count') | default(0) %}
                    {% set total = state_attr('sensor.daily_tasks', 'total_count') | default(0) %}
                    {% if total > 0 %}
                    **{{ verified }}/{{ total }}** tasks verified today
                    {% else %}
                    No tasks available for today.
                    {% endif %}

                # Task 1 Card - Only show if at least 1 task exists
                - type: conditional
                  conditions:
                    - condition: numeric_state
                      entity: sensor.daily_tasks
                      attribute: total_count
                      above: 0
                  card:
                    type: vertical-stack
                    cards:
                      - type: horizontal-stack
                        cards:
                          - type: markdown
                            content: |
                              {% set tasks = state_attr('sensor.daily_tasks', 'tasks') %}
                              {% if tasks and tasks | length > 0 %}
                              {% set t = tasks[0] %}
                              
                              ### {{ t.status_emoji }} Task 1: {{ t.title }}
                              
                              {{ t.description }}
                              
                              **Target:** {{ t.target_value }}{{ t.target_unit }} (from {{ t.baseline_value }}{{ t.target_unit }})  
                              **Difficulty:** {{ t.difficulty_display }}  
                              {% if t.area_name %}**Area:** {{ t.area_name }}{% endif %}
                              
                              {% if t.verified %}
                              ‚úÖ **VERIFIED!** You achieved the target!
                              {% else %}
                              üéØ **Active** - Complete this today!
                              {% endif %}
                              {% endif %}

                      - type: horizontal-stack
                        cards:
                          - type: button
                            name: Too Easy
                            icon: mdi:emoticon-happy-outline
                            icon_height: 30px
                            tap_action:
                              action: call-service
                              service: green_shift.submit_task_feedback
                              data:
                                task_index: 0
                                feedback: too_easy
                            entity: sensor.daily_tasks
                            show_state: false
                          
                          - type: button
                            name: Just Right
                            icon: mdi:emoticon-neutral-outline
                            icon_height: 30px
                            tap_action:
                              action: call-service
                              service: green_shift.submit_task_feedback
                              data:
                                task_index: 0
                                feedback: just_right
                            entity: sensor.daily_tasks
                            show_state: false
                          
                          - type: button
                            name: Too Hard
                            icon: mdi:emoticon-sad-outline
                            icon_height: 30px
                            tap_action:
                              action: call-service
                              service: green_shift.submit_task_feedback
                              data:
                                task_index: 0
                                feedback: too_hard
                            entity: sensor.daily_tasks
                            show_state: false

                # Task 2 Card - Only show if at least 2 tasks exist
                - type: conditional
                  conditions:
                    - condition: numeric_state
                      entity: sensor.daily_tasks
                      attribute: total_count
                      above: 1
                  card:
                    type: vertical-stack
                    cards:
                      - type: horizontal-stack
                        cards:
                          - type: markdown
                            content: |
                              {% set tasks = state_attr('sensor.daily_tasks', 'tasks') %}
                              {% if tasks and tasks | length > 1 %}
                              {% set t = tasks[1] %}

                              ---

                              ### {{ t.status_emoji }} Task 2: {{ t.title }}
                              
                              {{ t.description }}
                              
                              **Target:** {{ t.target_value }}{{ t.target_unit }} (from {{ t.baseline_value }}{{ t.target_unit }})  
                              **Difficulty:** {{ t.difficulty_display }}  
                              {% if t.area_name %}**Area:** {{ t.area_name }}{% endif %}
                              
                              {% if t.verified %}
                              ‚úÖ **VERIFIED!** You achieved the target!
                              {% else %}
                              üéØ **Active** - Complete this today!
                              {% endif %}
                              {% endif %}

                      - type: horizontal-stack
                        cards:
                          - type: button
                            name: Too Easy
                            icon: mdi:emoticon-happy-outline
                            icon_height: 30px
                            tap_action:
                              action: call-service
                              service: green_shift.submit_task_feedback
                              data:
                                task_index: 1
                                feedback: too_easy
                            entity: sensor.daily_tasks
                            show_state: false
                          
                          - type: button
                            name: Just Right
                            icon: mdi:emoticon-neutral-outline
                            icon_height: 30px
                            tap_action:
                              action: call-service
                              service: green_shift.submit_task_feedback
                              data:
                                task_index: 1
                                feedback: just_right
                            entity: sensor.daily_tasks
                            show_state: false
                          
                          - type: button
                            name: Too Hard
                            icon: mdi:emoticon-sad-outline
                            icon_height: 30px
                            tap_action:
                              action: call-service
                              service: green_shift.submit_task_feedback
                              data:
                                task_index: 1
                                feedback: too_hard
                            entity: sensor.daily_tasks
                            show_state: false

                # Task 3 Card - Only show if 3 tasks exist
                - type: conditional
                  conditions:
                    - condition: numeric_state
                      entity: sensor.daily_tasks
                      attribute: total_count
                      above: 2
                  card:
                    type: vertical-stack
                    cards:
                      - type: horizontal-stack
                        cards:
                          - type: markdown
                            content: |
                              {% set tasks = state_attr('sensor.daily_tasks', 'tasks') %}
                              {% if tasks and tasks | length > 2 %}
                              {% set t = tasks[2] %}

                              ---

                              ### {{ t.status_emoji }} Task 3: {{ t.title }}
                              
                              {{ t.description }}
                              
                              **Target:** {{ t.target_value }}{{ t.target_unit }} (from {{ t.baseline_value }}{{ t.target_unit }})  
                              **Difficulty:** {{ t.difficulty_display }}  
                              {% if t.area_name %}**Area:** {{ t.area_name }}{% endif %}
                              
                              {% if t.verified %}
                              ‚úÖ **VERIFIED!** You achieved the target!
                              {% else %}
                              üéØ **Active** - Complete this today!
                              {% endif %}
                              {% endif %}

                      - type: horizontal-stack
                        cards:
                          - type: button
                            name: Too Easy
                            icon: mdi:emoticon-happy-outline
                            icon_height: 30px
                            tap_action:
                              action: call-service
                              service: green_shift.submit_task_feedback
                              data:
                                task_index: 2
                                feedback: too_easy
                            entity: sensor.daily_tasks
                            show_state: false
                          
                          - type: button
                            name: Just Right
                            icon: mdi:emoticon-neutral-outline
                            icon_height: 30px
                            tap_action:
                              action: call-service
                              service: green_shift.submit_task_feedback
                              data:
                                task_index: 2
                                feedback: just_right
                            entity: sensor.daily_tasks
                            show_state: false
                          
                          - type: button
                            name: Too Hard
                            icon: mdi:emoticon-sad-outline
                            icon_height: 30px
                            tap_action:
                              action: call-service
                              service: green_shift.submit_task_feedback
                              data:
                                task_index: 2
                                feedback: too_hard
                            entity: sensor.daily_tasks
                            show_state: false

                # Verify All Tasks Button - Only show if tasks exist
                - type: conditional
                  conditions:
                    - condition: numeric_state
                      entity: sensor.daily_tasks
                      attribute: total_count
                      above: 0
                  card:
                    type: button
                    name: "Verify All Tasks"
                    icon: mdi:check-circle
                    icon_height: 20px
                    tap_action:
                      action: call-service
                      service: green_shift.verify_tasks
                    show_state: false

                # Summary - Only show if tasks exist
                - type: conditional
                  conditions:
                    - condition: numeric_state
                      entity: sensor.daily_tasks
                      attribute: total_count
                      above: 0
                  card:
                    type: markdown
                    content: |
                      ---
                      ### üí° How Feedback Works
                      
                      Rate each task's difficulty to help the system adjust future challenges:
                      - **üòä Too Easy** ‚Üí Next time will be harder
                      - **üòê Just Right** ‚Üí Difficulty stays the same
                      - **üò∞ Too Hard** ‚Üí Next time will be easier
                      
                      Tasks are verified every 15 minutes, but you can also manually trigger verification by clicking on the "Verify All Tasks" button to see which ones you achieved today!

  # ========== TAB 4: COLLABORATIVE GOAL ==========
  - title: Collaborative Goal
    path: collaborative
    icon: mdi:account-group
    type: panel
    cards:
      - type: vertical-stack
        cards:
          - type: conditional
            conditions:
              - entity: sensor.research_phase
                state: baseline
            card:
              type: markdown
              content: |
                ## üîí Goal Locked
                This section will unlock after the 14-day calibration phase is complete.

          - type: conditional
            conditions:
              - entity: sensor.research_phase
                state: active
            card:
              type: vertical-stack
              cards:
                - type: markdown
                  content: |
                    # Weekly Challenge
                    Target: Reduce consumption to **{{ 100 - state_attr('sensor.weekly_challenge', 'goal') | int }}%** of your baseline.
                    
                    *(Goal: {{ state_attr('sensor.weekly_challenge', 'goal') }}% Reduction)*

                - type: gauge
                  entity: sensor.weekly_challenge
                  name: Consumption vs Baseline (%)
                  min: 0
                  max: 100
                  severity:
                    green: 0
                    yellow: 75
                    red: 100
                    
                - type: entities
                  title: Challenge Details
                  entities:
                    - entity: sensor.weekly_challenge
                    
                - type: markdown
                  content: |
                    **Current Average**: {{ state_attr('sensor.weekly_challenge', 'current_avg_w') }} kW
                    **Target Average**: {{ state_attr('sensor.weekly_challenge', 'target_avg_w') }} kW
                    **Baseline**: {{ state_attr('sensor.weekly_challenge', 'baseline_w') }} kW
                    **Reduction Goal**: {{ state_attr('sensor.weekly_challenge', 'goal') }} %

  # ========== TAB 5: USER PROFILE ==========
  - title: Profile
    path: profile
    icon: mdi:account-circle
    type: panel
    cards:
      - type: vertical-stack
        cards:
          - type: conditional
            conditions:
              - entity: sensor.research_phase
                state: baseline
            card:
              type: markdown
              content: |
                ## üöß Profile Building...
                We are currently calibrating your baseline. 
                Your personal eco-stats and levels will unlock in **{{ state_attr('sensor.research_phase', 'days_remaining') }} days**.

          - type: conditional
            conditions:
              - entity: sensor.research_phase
                state: active
            card:
              type: vertical-stack
              cards:
                # --- PLAYER LEVEL CARD ---
                - type: markdown
                  content: |
                    {% set tasks = states('sensor.tasks_completed') | int %}
                    {% if tasks < 5 %}
                    # üê£ Level 1: Novice
                    *Complete more daily tasks to evolve!*
                    {% elif tasks < 15 %}
                    # üåø Level 2: Eco-Apprentice
                    *You're getting the hang of this!*
                    {% elif tasks < 30 %}
                    # üå≥ Level 3: Guardian
                    *Amazing dedication!*
                    {% else %}
                    # üëë Level 4: Planet Master
                    *You are an energy saving legend.*
                    {% endif %}
                    
                    ---
                    **Total Tasks Completed:** {{ tasks }}

                # --- RPG STATS GAUGES ---
                - type: horizontal-stack
                  cards:
                    - type: gauge
                      entity: sensor.behaviour_index
                      name: Engagement
                      min: 0
                      max: 1
                      severity:
                        red: 0
                        yellow: 0.4
                        green: 0.8
                    
                    - type: gauge
                      entity: sensor.fatigue_index
                      name: Fatigue Risk
                      min: 0
                      max: 1
                      severity:
                        green: 0
                        yellow: 0.5
                        red: 0.8

                # --- TOTAL IMPACT GLANCE ---
                - type: glance
                  title: Lifetime Impact
                  columns: 3
                  entities:
                    - entity: sensor.savings_accumulated
                      name: Money Saved
                    - entity: sensor.co2_saved
                      name: CO‚ÇÇ Avoided
                    - entity: sensor.weekly_challenge
                      name: Current Goal

                # --- "DID YOU KNOW?" CONTEXT ---
                - type: markdown
                  content: |
                    ### üåç Your Real-World Impact
                    {% set trees = state_attr('sensor.co2_saved', 'trees') %}
                    {% set flights = state_attr('sensor.co2_saved', 'flights') %}
                    {% set km = state_attr('sensor.co2_saved', 'car_km') %}
                    
                    Your savings so far are equivalent to:
                    * Planting **{{ trees }} mature trees** üå≤
                    * Offsetting **{{ flights }} short-haul flights** ‚úàÔ∏è
                    * Avoiding **{{ km }} km** driven in a gas car üöó

  # ========== TAB 6: SETTINGS ==========
  - title: Settings
    path: settings
    icon: mdi:cog
    type: panel
    cards:
      - type: vertical-stack
        cards:
          - type: markdown
            content: |
              # ‚öôÔ∏è System Configuration
              Manage your preferences, cost settings and view system health.

          # --- SYSTEM STATUS (Read-Only) ---
          - type: entities
            title: System Status
            show_header_toggle: false
            state_color: true
            entities:
              - entity: sensor.research_phase
                name: Current Phase
                icon: mdi:flask-outline
                secondary_info: last-updated
              
              - entity: sensor.energy_baseline
                name: Learned Baseline
                icon: mdi:chart-bell-curve-cumulative

          # --- CONFIGURATION (User Inputs) ---
          - type: entities
            title: Preferences & Costs
            show_header_toggle: false
            entities:
              # --- SECTION: GOALS ---
              - type: section
                label: "üéØ Energy Goals"
              
              - type: conditional
                conditions:
                  - entity: sensor.research_phase
                    state: baseline
                row:
                  type: attribute
                  entity: sensor.research_phase
                  attribute: days_remaining
                  name: "Goals Locked (Calibration)"
                  icon: mdi:lock-clock
                  suffix: "days left"

              - type: conditional
                conditions:
                  - entity: sensor.research_phase
                    state: active
                row:
                  entity: input_number.energy_saving_target
                  name: "Weekly Reduction Target (%)"
                  icon: mdi:target

              # --- SECTION: ECONOMICS ---
              - type: section
                label: "üí∞ Costs & Currency"
              
              - entity: input_select.currency
                name: Currency
                icon: mdi:cash-100
              
              - entity: input_number.electricity_price
                name: Electricity Price (per kWh)
                icon: mdi:lightning-bolt-circle

          # --- HELP FOOTER ---
          - type: markdown
            content: |
              ### ‚ÑπÔ∏è Quick Guide
              * **Baseline Phase:** The system learns your normal usage for 14 days.
              * **Reduction Target:** Once active, the AI will set weekly challenges to reduce your consumption by this percentage.