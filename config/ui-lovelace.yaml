title: Green Shift
views:
  # ========== TAB 1: DEVICES ==========
  - title: Devices
    path: devices
    icon: mdi:power-plug
    type: panel
    cards:
      - type: vertical-stack
        cards:
          - type: markdown
            content: |
              # Monitored Devices
              Real-time values from automatically discovered **hardware sensors**.

              ---
              ### üìò Quick Guide
              {%- set p = state_attr('sensor.hardware_sensors', 'power') %}
              {%- set e = state_attr('sensor.hardware_sensors', 'energy') %}
              {%- set l = state_attr('sensor.hardware_sensors', 'illuminance') %}
              {%- set h = state_attr('sensor.hardware_sensors', 'humidity') %}

              {%- if p and p | length > 0 %}
              **‚ö° W (Watts):** *Instant Speed.* 
              Shows how much electricity is flowing right now. Turning on a device makes this number go up immediately.
              {%- endif %}

              {%- if e and e | length > 0 %}
              **üîã kWh (Kilowatt-hours):** *Accumulated Usage.*
              This counts the total volume of energy used over time (what you pay for). 
              *Impact Example:* **1 kWh** is roughly the energy needed to run a **washing machine cycle**.
              {%- endif %}

              {%- if l and l | length > 0 %}
              **üí° Lux:** *Brightness.*
              Measures light intensity. 0 is pitch black, 500 is a bright place.
              {%- endif %}
              
              {%- if h and h | length > 0 %}
              **üíß Humidity (%):** *Moisture.*
              How much water is in the air. 40-60% is usually comfortable.
              {%- endif %}

          # --- GLOBAL OVERVIEW ---
          - type: horizontal-stack
            cards:
              - type: sensor
                entity: sensor.current_consumption
                name: Total Load
                graph: line
              - type: sensor
                entity: sensor.current_hourly_cost
                name: Current Hourly Cost
                graph: line
              - type: sensor
                entity: sensor.daily_cost
                name: Current Daily Cost
                graph: line
              - type: sensor
                entity: sensor.daily_co2_estimate
                name: Current Daily CO2 (kg)
                graph: line

          # --- DYNAMIC AREA DASHBOARD ---
          - type: vertical-stack
            cards:
              - type: markdown
                content: "### üè† Area Snapshot"
              
              # The Dropdown Menu
              - type: entities
                entities:
                  - entity: select.dashboard_area_filter
                    name: Filter by Room
                style: |
                  ha-card {
                    box-shadow: none;
                    background: none;
                    margin-bottom: -20px; /* Pulls the table up closer */
                  }

              # The filtered table
              - type: markdown
                content: >
                  {%- set filter = states('select.dashboard_area_filter') -%}
                  {%- set ns = namespace(areas=[]) -%}

                  {%- for cat in ['power', 'energy', 'temperature', 'humidity', 'illuminance', 'occupancy'] -%}
                    {%- set sensors = state_attr('sensor.hardware_sensors', cat) -%}
                    {%- if sensors -%}
                      {%- for s in sensors -%}
                        {%- set area_name = s.get('area') -%}
                        {%- if area_name and area_name not in ns.areas -%}
                          {%- set ns.areas = ns.areas + [area_name] -%}
                        {%- endif -%}
                      {%- endfor -%}
                    {%- endif -%}
                  {%- endfor -%}

                  {%- if ns.areas | length == 0 -%}
                  ‚ö†Ô∏è **No areas detected.**
                  {%- endif -%}
                  
                  {%- for area in ns.areas | sort -%}
                    {%- if filter in ['All Areas', 'unknown', 'unavailable'] or filter == area -%}
                      <h3>{{ area }}</h3>
                      <table width="100%">
                      {%- for cat in ['power', 'energy', 'temperature', 'humidity', 'illuminance', 'occupancy'] -%}
                        {%- set sensors = state_attr('sensor.hardware_sensors', cat) -%}
                        {%- if sensors -%}
                          {%- for s in sensors -%}
                            {%- if s.get('area') == area -%}
                              <tr>
                                <td width="5%" style="text-align: center;">
                                  <ha-icon icon="{{ 'mdi:lightning-bolt' if cat == 'power' else 'mdi:counter' if cat == 'energy' else 'mdi:thermometer' if cat == 'temperature' else 'mdi:water-percent' if cat == 'humidity' else 'mdi:brightness-5' if cat == 'illuminance' else 'mdi:eye' }}" style="width: 20px; color: var(--secondary-text-color);"></ha-icon>
                                </td>
                                <td style="text-align: left;">{{ s.name }}</td>
                                <td style="text-align: right;">
                                  {%- if cat == 'occupancy' -%}
                                    {{ 'üî¥' if s.value == 'on' else 'üü¢' }}
                                  {%- else -%}
                                    <b>{{ s.value }}</b> <small>{{ s.unit }}</small>
                                  {%- endif -%}
                                </td>
                              </tr>
                            {%- endif -%}
                          {%- endfor -%}
                        {%- endif -%}
                      {%- endfor -%}
                      </table>
                    {%- endif -%}
                  {%- endfor -%}

  # ========== TAB 2: DASHBOARD ==========
  - title: Dashboard
    path: dashboard
    icon: mdi:chart-line
    type: panel
    cards:
      - type: vertical-stack
        cards:
          - type: markdown
            content: |
              # Dashboard 
              Analyze your energy consumption patterns and identify opportunities for savings.

          - type: conditional
            conditions:
              - entity: sensor.research_phase
                state: baseline
            card:
              type: markdown
              content: |
                ## üìä Calibration in Progress
                The system is learning your habits.
                **{{ state_attr('sensor.research_phase', 'days_remaining') }} days remaining** until the History Graph becomes available.

          # --- HISTORY GRAPH ---
          - type: history-graph
            title: Consumption vs Baseline (Last Week)
            hours_to_show: 168
            entities:
              - entity: sensor.current_consumption
                name: Current Consumption
              - entity: sensor.energy_baseline
                name: Baseline
          
          # --- AREA CONSUMPTION TABLE ---
          - type: markdown
            content: |
              ### ‚ö° Energy by Area
              
              {%- set sensors = state_attr('sensor.hardware_sensors', 'energy') -%}
              {%- set ns = namespace(area_sums={}, total=0) -%}

              {%- if sensors -%}
                {%- for s in sensors -%}
                  {%- if s.value is not none -%}
                    {%- set ns.total = ns.total + s.value -%}
                    {%- set area = s.area if s.area else 'No Area' -%}
                    {%- set current = ns.area_sums.get(area, 0) -%}
                    {%- set new_dict = {area: current + s.value} -%}
                    {%- set ns.area_sums = dict(ns.area_sums, **new_dict) -%}
                  {%- endif -%}
                {%- endfor -%}
              {%- endif -%}

              {%- if ns.total == 0 -%}
              No energy data collected yet.
              {%- else -%}
              
              <table width="100%">
                <thead>
                  <tr>
                    <th style="text-align: left;">Area</th>
                    <th style="text-align: right;">Usage</th>
                    <th style="text-align: right;">Share</th>
                    <th style="text-align: left;">Distribution</th>
                  </tr>
                </thead>
                <tbody>
                {%- for area, kwh in ns.area_sums.items() | sort(attribute='1', reverse=True) -%}
                  {%- set pct = (kwh / ns.total * 100) | round(0) | int -%}
                  {%- set blocks = (pct / 10) | round(0) | int -%}
                  {%- set bar = '‚ñì' * blocks + '‚ñë' * (10 - blocks) -%}
                  <tr>
                    <td style="text-align: left;"><b>{{ area }}</b></td>
                    <td style="text-align: right;">{{ kwh | round(2) }} kWh</td>
                    <td style="text-align: right;">{{ pct }}%</td>
                    <td style="text-align: left; color: var(--primary-color);">{{ bar }}</td>
                  </tr>
                {%- endfor -%}
                </tbody>
              </table>
              {%- endif -%}

          # --- TOP 5 POWER CONSUMERS ---
          - type: markdown
            content: |
              ### üèÜ Top 5 Power Consumers
              {%- set sensors = state_attr('sensor.hardware_sensors', 'power') -%}
              {%- if sensors -%}
              {# 1. Filter valid sensors and sort by highest Watts first #}
              {%- set top_devices = sensors
                  | selectattr('value', 'ne', None)
                  | sort(attribute='value', reverse=True)
                  | list
              -%}
              {# 2. Get the max value to scale the bars relative to the biggest hog #}
              {%- set max_val = top_devices[0].value if top_devices else 1 -%}

              <table width="100%">
                <thead>
                  <tr>
                    <th style="text-align: left;">Device</th>
                    <th style="text-align: right;">Load</th>
                    <th style="text-align: left; padding-left: 10px;">Impact</th>
                  </tr>
                </thead>
                <tbody>
                  {%- for s in top_devices[:5] -%}
                  {%- set pct = (s.value / max_val * 100) | int -%}
                  {%- set blocks = (pct / 10) | round(0) | int -%}
                  {%- set bar = '‚ñà' * blocks + '‚ñë' * (10 - blocks) -%}
                  <tr>
                    <td style="text-align: left;">{{ s.name }}</td>
                    <td style="text-align: right;"><b>{{ s.value }} W</b></td>
                    <td style="text-align: left; padding-left: 10px; color: var(--primary-color);">
                      {{ bar }}
                    </td>
                  </tr>
                  {%- endfor -%}
                </tbody>
              </table>
              {%- else -%}
              No active devices detected.
              {%- endif -%}


  # ========== TAB 3: CHALLENGES ==========
  - title: Challenges
    path: tasks
    icon: mdi:clipboard-check
    type: panel
    visible:
      - condition: state
        entity: sensor.research_phase
        state: active
    cards:
      - type: vertical-stack
        cards:
          - type: markdown
            content: |
              # Daily Challenges
              Complete today's random tasks to improve your energy efficiency!
          - type: markdown
            content: |
              {% set tasks = state_attr('sensor.daily_tasks', 'tasks') %}
              {% if tasks %}
                {% for task in tasks %}
                - **{{ task.title }}**
                  *{{ task.description }}*
                {% endfor %}
              {% else %}
                No tasks available yet.
              {% endif %}

  # ========== TAB 4: COLLABORATIVE GOAL ==========
  - title: Collaborative Goal
    path: collaborative
    icon: mdi:account-group
    type: panel
    visible:
      - condition: state
        entity: sensor.research_phase
        state: active
    cards:
      - type: vertical-stack
        cards:
          - type: markdown
            # [FIX] This now calculates the target dynamically (e.g., 100 - 25 = 75%)
            content: |
              # Weekly Challenge
              Target: Reduce consumption to **{{ 100 - state_attr('sensor.weekly_challenge', 'goal') | int }}%** of your baseline.
              
              *(Goal: {{ state_attr('sensor.weekly_challenge', 'goal') }}% Reduction)*

          - type: gauge
            entity: sensor.weekly_challenge
            name: Consumption vs Baseline (%)
            min: 0
            max: 100
            # Note: Gauge colors are static in standard cards and won't move with the slider.
            severity:
              green: 0
              yellow: 75
              red: 100
              
          - type: entities
            title: Challenge Details
            entities:
              - entity: sensor.weekly_challenge
              
          - type: markdown
            content: |
              **Current Average**: {{ state_attr('sensor.weekly_challenge', 'current_avg_w') }} kW
              **Target Average**: {{ state_attr('sensor.weekly_challenge', 'target_avg_w') }} kW
              **Baseline**: {{ state_attr('sensor.weekly_challenge', 'baseline_w') }} kW
              **Reduction Goal**: {{ state_attr('sensor.weekly_challenge', 'goal') }} %

  # ========== TAB 5: USER PROFILE ==========
  - title: Profile
    path: profile
    icon: mdi:account-circle
    type: panel
    cards:
      - type: vertical-stack
        cards:
          - type: conditional
            conditions:
              - entity: sensor.research_phase
                state: baseline
            card:
              type: markdown
              content: |
                ## Profile Under Construction
                **Calibration Mode**: {{ state_attr('sensor.research_phase', 'days_remaining') }} days remaining

          - type: glance
            title: Total Impact
            entities:
              - entity: sensor.savings_accumulated
              - entity: sensor.co2_saved
              - entity: sensor.tasks_completed

          - type: entities
            title: Engagement Metrics
            entities:
              - entity: sensor.behaviour_index
              - entity: sensor.fatigue_index

          - type: gauge
            entity: sensor.collaborative_goal_progress
            name: Weekly Target
            min: 0
            max: 100
            severity:
              green: 0
              yellow: 85
              red: 100

# ========== TAB 6: SETTINGS ==========
  - title: Settings
    path: settings
    icon: mdi:cog
    type: panel
    cards:
      - type: vertical-stack
        cards:
          - type: markdown
            content: "# System Settings"
            
          - type: entities
            title: Goals and Preferences
            entities:
              - type: conditional
                conditions:
                  - entity: sensor.research_phase
                    state: baseline
                row:
                  type: section
                  label: "‚ö†Ô∏è Goals Locked: Calibrating..."

              - type: conditional
                conditions:
                  - entity: sensor.research_phase
                    state: active
                row:
                  entity: input_number.energy_saving_target
                  name: "Reduction Goal"
              
              - type: section
                label: "General"
              - entity: input_select.currency
              - entity: input_number.electricity_price

          - type: entities
            title: Status
            entities:
              - entity: sensor.research_phase
              - entity: sensor.energy_baseline