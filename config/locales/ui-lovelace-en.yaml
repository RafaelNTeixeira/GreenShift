# title: Green Shift
# views:
#   # ========== TAB 1: DEVICES ==========
#   - !include lovelace-views/devices.yaml

#   # ========== TAB 2: DASHBOARD ==========
#   - !include lovelace-views/dashboard.yaml

#   # ========== TAB 3: CHALLENGES ==========
#   - !include lovelace-views/challenges.yaml

#   # ========== TAB 4: COLLABORATIVE GOAL ==========
#   - !include lovelace-views/collaborative.yaml

#   # ========== TAB 5: NOTIFICATIONS ==========
#   - !include lovelace-views/notifications.yaml

#   # ========== TAB 6: USER PROFILE ==========
#   - !include lovelace-views/profile.yaml

#   # ========== TAB 7: SETTINGS ==========
#   - !include lovelace-views/settings.yaml

# Green Shift - Lovelace Dashboard
title: Green Shift
views:

# ========== TAB 1: DEVICES ==========
- title: Devices
  path: devices
  icon: mdi:power-plug
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: markdown
          content: |
            # ğŸ”Œ Monitored Devices
            Real-time values from automatically discovered **hardware sensors**.
        # --- GLOBAL OVERVIEW ---
        - type: grid
          columns: 2
          square: false
          cards:
            - type: vertical-stack
              cards:
                - type: sensor
                  entity: sensor.current_consumption
                  name: âš¡ Total Load
                  graph: line
                - type: markdown
                  content: >
                    <p style="margin: -12px 16px 8px; font-size: 12px; color: var(--secondary-text-color);">Instantaneous power being consumed right now (W)</p>
            - type: vertical-stack
              cards:
                - type: sensor
                  entity: sensor.current_cost_per_hour
                  name: ğŸ’µ Hourly Cost
                  graph: line
                - type: markdown
                  content: >
                    <p style="margin: -12px 16px 8px; font-size: 12px; color: var(--secondary-text-color);">Estimated cost at the current rate of consumption</p>
            - type: vertical-stack
              cards:
                - type: sensor
                  entity: sensor.daily_cost
                  name: ğŸ’° Daily Cost
                  graph: line
                - type: markdown
                  content: >
                    <p style="margin: -12px 16px 8px; font-size: 12px; color: var(--secondary-text-color);">Total energy cost accumulated today</p>
            - type: vertical-stack
              cards:
                - type: sensor
                  entity: sensor.daily_co2_estimate
                  name: ğŸŒ± Daily CO2
                  graph: line
                - type: markdown
                  content: >
                    <p style="margin: -12px 16px 8px; font-size: 12px; color: var(--secondary-text-color);">Estimated COâ‚‚ emissions from today's energy use (kg)</p>

        # --- DYNAMIC AREA DASHBOARD ---
        - type: vertical-stack
          cards:
            # Filter Input
            - type: entities
              entities:
                - entity: select.dashboard_area_filter
                  name: Filter by Room
                  icon: mdi:filter-variant
              style: |
                ha-card {
                  box-shadow: none;
                  background: none;
                  margin-bottom: -15px;
                }

            - type: markdown
              content: |
                {%- set filter = states('select.dashboard_area_filter') -%}
                {%- set ns = namespace(areas=[]) -%}
                {%- set cats = ['power', 'energy', 'temperature', 'humidity', 'illuminance', 'occupancy'] -%}

                {# --- 1. Collect Unique Areas --- #}
                {%- for c in cats -%}
                  {%- set sensors = state_attr('sensor.hardware_sensors', c) -%}
                  {%- if sensors and sensors is iterable -%}
                    {%- for s in sensors -%}
                      {%- set area = s.get('area', 'Unassigned') -%}
                      {%- if area and area not in ns.areas -%}
                        {%- set ns.areas = ns.areas + [area] -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}
                {%- endfor -%}

                {# --- 2. Render Tables by Area --- #}
                {%- if ns.areas | length == 0 -%}
                  <p style="text-align: center;">âš ï¸ <b>No sensors or areas detected.</b></p>
                {%- else -%}
                  {%- for area in ns.areas | sort -%}
                    {# Check Filter #}
                    {%- if filter in ['All Areas', 'unknown', 'unavailable', 'None'] or filter == area -%}

                      <h3>ğŸ“ {{ area }}</h3>
                      <table width="100%">
                      {%- for c in cats -%}
                        {%- set sensors = state_attr('sensor.hardware_sensors', c) -%}
                        {%- if sensors and sensors is iterable -%}
                          {%- for s in sensors -%}
                            {%- if s.get('area', 'Unassigned') == area -%}
                              <tr>
                                <td width="30px">
                                  <ha-icon icon="{{ 'mdi:lightning-bolt' if c == 'power' else 'mdi:counter' if c == 'energy' else 'mdi:thermometer' if c == 'temperature' else 'mdi:water-percent' if c == 'humidity' else 'mdi:brightness-5' if c == 'illuminance' else 'mdi:eye' }}" style="width: 20px; color: var(--secondary-text-color);"></ha-icon>
                                </td>
                                <td>{{ s.name }}</td>
                                <td align="right">
                                  {%- if c == 'occupancy' -%}
                                    {{ 'Occupied ğŸ”´' if s.value == 'on' else 'Clear ğŸŸ¢' }}
                                  {%- else -%}
                                    <b>{{ s.value }}</b> <small>{{ s.unit }}</small>
                                  {%- endif -%}
                                </td>
                              </tr>
                            {%- endif -%}
                          {%- endfor -%}
                        {%- endif -%}
                      {%- endfor -%}
                      </table>
                      <hr style="border: 0; border-bottom: 1px solid var(--divider-color); margin: 15px 0;">

                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}

        # --- LEGEND ---
        - type: markdown
          content: |
            ### ğŸ“˜ Quick Guide
            {% set p = state_attr('sensor.hardware_sensors', 'power') %}
            {% set e = state_attr('sensor.hardware_sensors', 'energy') %}
            {% set l = state_attr('sensor.hardware_sensors', 'illuminance') %}
            {% set h = state_attr('sensor.hardware_sensors', 'humidity') %}

            {% if p and p | length > 0 %}
            **âš¡ Power (Watts):** *The "Speedometer"*
            > Shows how much electricity you are using **right now**.
            > *Tip:* If this is high, a "heavy" appliance like the Oven or AC is running.

            ---
            {% endif %}

            {% if e and e | length > 0 %}
            **ğŸ”‹ Energy (kWh):** *The "Odometer"*
            > The total amount used over time. This is what shows up on your **Electric Bill**.
            > *Scale:* **1 unit (kWh)** is roughly one full load of laundry.

            ---
            {% endif %}

            {% if l and l | length > 0 %}
            **ğŸ’¡ Light (Lux):** *Brightness*
            > Measures how bright the room is.
            > *Scale:* **0** (Pitch Black) â†’ **150** (Typical Living Room) â†’ **500+** (Bright Office).

            ---
            {% endif %}

            {% if h and h | length > 0 %}
            **ğŸ’§ Humidity:** *Air Moisture*
            > **40-60%** is the "Comfort Zone."
            > *Warning:* Above **70%** feels "muggy" and risks mold; below **30%** feels very dry.
            {% endif %}

# ========== DASHBOARD TAB ==========
- title: Dashboard
  path: dashboard
  icon: mdi:chart-line
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: markdown
          content: |
            # ğŸ“Š Dashboard
            Analyze your energy consumption patterns and identify opportunities for savings.

        # --- CHART SECTION ---
        - type: vertical-stack
          cards:
            - type: markdown
              content: |
                ### ğŸ“ˆ Performance vs. Baseline
                <div style="background: var(--card-background-color); border: 1px solid var(--divider-color); padding: 10px; border-radius: 6px; font-size: 13px; color: var(--secondary-text-color); margin-bottom: 0px;">
                  â„¹ï¸ <b>What is "Baseline Consumption"?</b><br>
                  This line represents your average energy consumption. It will be adjusted overtime.
                </div>

            - type: history-graph
              hours_to_show: 168
              entities:
                - entity: sensor.current_consumption
                  name: Current Usage
                - entity: sensor.energy_baseline
                  name: Baseline Consumption

        # --- AREA CONSUMPTION TABLE ---
        - type: markdown
          content: |
            ### âš¡ Power Usage by Area

            {%- set sensors = state_attr('sensor.hardware_sensors', 'power') -%}
            {%- set ns = namespace(area_sums={}, total=0) -%}

            {%- if sensors -%}
              {%- for s in sensors -%}
                {%- if s.value is not none -%}
                  {%- set ns.total = ns.total + s.value -%}
                  {%- set area = s.area if s.area else 'No Area' -%}
                  {%- set current = ns.area_sums.get(area, 0) -%}
                  {%- set new_dict = {area: current + s.value} -%}
                  {%- set ns.area_sums = dict(ns.area_sums, **new_dict) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}

            {%- if ns.total == 0 -%}
            </br>
            ğŸ“­ No area data collected.
            {%- else -%}

            </br>

            <table width="100%">
              <thead>
                <tr>
                  <th style="text-align: left;">ğŸ“ Area</th>
                  <th style="text-align: right;">âš¡ Usage</th>
                  <th style="text-align: right;">ğŸ“Š Share</th>
                  <th style="text-align: left;">ğŸ“Š Distribution</th>
                </tr>
              </thead>
              <tbody>
              {%- for area, w in ns.area_sums.items() | sort(attribute='1', reverse=True) -%}
                {%- set pct = (w / ns.total * 100) | round(0) | int -%}
                {%- set blocks = (pct / 10) | round(0) | int -%}
                {%- set bar = 'â–ˆ' * blocks + 'â–‘' * (10 - blocks) -%}
                <tr>
                  <td style="text-align: left;"><b>{{ area }}</b></td>
                  <td style="text-align: right;">{{ w | round(2) }} W</td>
                  <td style="text-align: right;">{{ pct }}%</td>
                  <td style="text-align: left; color: var(--primary-color);">{{ bar }}</td>
                </tr>
              {%- endfor -%}
              </tbody>
            </table>
            {%- endif -%}

        # --- TOP 5 POWER CONSUMERS ---
        - type: markdown
          content: |
            ### ğŸ† Top 5 Power Consumers
            {%- set sensors = state_attr('sensor.hardware_sensors', 'power') -%}
            {%- if sensors -%}
            {# 1. Filter valid sensors and sort by highest Watts first #}
            {%- set top_devices = sensors
                | selectattr('value', 'ne', None)
                | sort(attribute='value', reverse=True)
                | list
            -%}
            {# 2. Get the max value to scale the bars relative to the biggest hog #}
            {%- set max_val = top_devices[0].value if (top_devices and top_devices[0].value > 0) else 1 -%}
            </br>
            <table width="100%">
              <thead>
                <tr>
                  <th style="text-align: left;">ğŸ”Œ Device</th>
                  <th style="text-align: right;">âš¡ Load</th>
                  <th style="text-align: left; padding-left: 10px;">ğŸ“Š Impact</th>
                </tr>
              </thead>
              <tbody>
                {%- for s in top_devices[:5] -%}
                {%- set pct = (s.value / max_val * 100) | int -%}
                {%- set blocks = (pct / 10) | round(0) | int -%}
                {%- set bar = 'â–ˆ' * blocks + 'â–‘' * (10 - blocks) -%}
                <tr>
                  <td style="text-align: left;">{{ s.name }}</td>
                  <td style="text-align: right;"><b>{{ s.value }} W</b></td>
                  <td style="text-align: left; padding-left: 10px; color: var(--primary-color);">
                    {{ bar }}
                  </td>
                </tr>
                {%- endfor -%}
              </tbody>
            </table>
            {%- else -%}
            </br>
            ğŸ˜´ No active devices detected.
            {%- endif -%}

# ========== TAB 3: CHALLENGES ==========
- title: Challenges
  path: tasks
  icon: mdi:clipboard-check
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: baseline
          card:
            type: markdown
            content: |
              ## ğŸ”’ Challenges Locked
              **{{ state_attr('sensor.research_phase', 'days_remaining') }} days** until unlock â³

        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: active
          card:
            type: vertical-stack
            cards:
              - type: markdown
                content: |
                  # ğŸ“… Daily Energy Challenges
                  {% set verified = state_attr('sensor.daily_tasks', 'verified_count') | default(0) %}
                  {% set total = state_attr('sensor.daily_tasks', 'total_count') | default(0) %}
                  {% if total > 0 %}
                  âœ… **{{ verified }}/{{ total }}** tasks verified today
                  {% else %}
                  ğŸ“­ No tasks available for today.
                  {% endif %}

              # --- STREAK BANNER ---
              - type: horizontal-stack
                cards:
                  - type: markdown
                    content: |
                      {% set s = states('sensor.daily_task_streak') | int(0) %}
                      {% if s >= 7 %}
                      ## ğŸ”¥ {{ s }} days
                      *Unstoppable!* â­
                      {% elif s >= 3 %}
                      ## ğŸ”¥ {{ s }} days
                      *Keep it going!* ğŸ’ª
                      {% elif s == 1 %}
                      ## ğŸ”¥ 1 day
                      *Good start!* ğŸŒ±
                      {% else %}
                      ## ğŸ”¥ 0 days
                      *Complete a task to start!*
                      {% endif %}
                      <small>Daily task streak</small>
                  - type: markdown
                    content: |
                      {% set s = states('sensor.weekly_challenge_streak') | int(0) %}
                      {% if s >= 4 %}
                      ## ğŸ† {{ s }} weeks
                      *Legendary!* ğŸŒŸ
                      {% elif s >= 2 %}
                      ## ğŸ† {{ s }} weeks
                      *On a roll!* ğŸ¯
                      {% elif s == 1 %}
                      ## ğŸ† 1 week
                      *First win!* ğŸ‰
                      {% else %}
                      ## ğŸ† 0 weeks
                      *Win this week to start!*
                      {% endif %}
                      <small>Weekly challenge streak</small>

              # Task 1 Card - Only show if at least 1 task exists
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 0
                card:
                  type: vertical-stack
                  cards:
                    - type: horizontal-stack
                      cards:
                        - type: markdown
                          content: |
                            {% set tasks = state_attr('sensor.daily_tasks', 'tasks') %}
                            {% if tasks and tasks | length > 0 %}
                            {% set t = tasks[0] %}

                            ### {{ t.status_emoji }} Task 1: {{ t.title }}

                            {{ t.description }}

                            **Target:** {{ t.target_value }}{{ t.target_unit }} (from {{ t.baseline_value }}{{ t.target_unit }})
                            **ğŸ“Š Difficulty:** {{ t.difficulty_display }}
                            {% if t.area_name %}**ğŸ“ Area:** {{ t.area_name }}{% endif %}

                            {% if t.verified %}
                            âœ… **VERIFIED!** You achieved the target!
                            {% else %}
                            ğŸ¯ **Active** - Complete this today!
                            {% endif %}
                            {% endif %}

                    - type: horizontal-stack
                      cards:
                        - type: button
                          name: Too Easy
                          icon: mdi:emoticon-happy-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 0
                              feedback: too_easy
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Just Right
                          icon: mdi:emoticon-neutral-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 0
                              feedback: just_right
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Too Hard
                          icon: mdi:emoticon-sad-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 0
                              feedback: too_hard
                          entity: sensor.daily_tasks
                          show_state: false

              # Task 2 Card - Only show if at least 2 tasks exist
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 1
                card:
                  type: vertical-stack
                  cards:
                    - type: horizontal-stack
                      cards:
                        - type: markdown
                          content: |
                            {% set tasks = state_attr('sensor.daily_tasks', 'tasks') %}
                            {% if tasks and tasks | length > 1 %}
                            {% set t = tasks[1] %}

                            ---

                            ### {{ t.status_emoji }} Task 2: {{ t.title }}

                            {{ t.description }}

                            **ğŸ¯ Target:** {{ t.target_value }}{{ t.target_unit }} (from {{ t.baseline_value }}{{ t.target_unit }})
                            **ğŸ“Š Difficulty:** {{ t.difficulty_display }}
                            {% if t.area_name %}**ğŸ“ Area:** {{ t.area_name }}{% endif %}

                            {% if t.verified %}
                            âœ… **VERIFIED!** You achieved the target!
                            {% else %}
                            ğŸ¯ **Active** - Complete this today!
                            {% endif %}
                            {% endif %}

                    - type: horizontal-stack
                      cards:
                        - type: button
                          name: Too Easy
                          icon: mdi:emoticon-happy-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 1
                              feedback: too_easy
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Just Right
                          icon: mdi:emoticon-neutral-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 1
                              feedback: just_right
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Too Hard
                          icon: mdi:emoticon-sad-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 1
                              feedback: too_hard
                          entity: sensor.daily_tasks
                          show_state: false

              # Task 3 Card - Only show if 3 tasks exist
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 2
                card:
                  type: vertical-stack
                  cards:
                    - type: horizontal-stack
                      cards:
                        - type: markdown
                          content: |
                            {% set tasks = state_attr('sensor.daily_tasks', 'tasks') %}
                            {% if tasks and tasks | length > 2 %}
                            {% set t = tasks[2] %}

                            ---

                            ### {{ t.status_emoji }} Task 3: {{ t.title }}

                            {{ t.description }}

                            **ğŸ¯ Target:** {{ t.target_value }}{{ t.target_unit }} (from {{ t.baseline_value }}{{ t.target_unit }})
                            **ğŸ“Š Difficulty:** {{ t.difficulty_display }}
                            {% if t.area_name %}**ğŸ“ Area:** {{ t.area_name }}{% endif %}

                            {% if t.verified %}
                            âœ… **VERIFIED!** You achieved the target!
                            {% else %}
                            ğŸ¯ **Active** - Complete this today!
                            {% endif %}
                            {% endif %}

                    - type: horizontal-stack
                      cards:
                        - type: button
                          name: Too Easy
                          icon: mdi:emoticon-happy-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 2
                              feedback: too_easy
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Just Right
                          icon: mdi:emoticon-neutral-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 2
                              feedback: just_right
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Too Hard
                          icon: mdi:emoticon-sad-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 2
                              feedback: too_hard
                          entity: sensor.daily_tasks
                          show_state: false

              # Verify All Tasks Button - Only show if tasks exist
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 0
                card:
                  type: button
                  name: "Verify All Tasks"
                  icon: mdi:check-circle
                  icon_height: 30px
                  tap_action:
                    action: call-service
                    service: green_shift.verify_tasks
                  show_state: false

              # Summary - Only show if tasks exist
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 0
                card:
                  type: markdown
                  content: |
                    ---
                    ### ğŸ’¡ How Feedback Works

                    Rate each task's difficulty to help the system adjust future challenges:
                    - **ğŸ˜Š Too Easy** â†’ Next time will be harder
                    - **ğŸ˜ Just Right** â†’ Difficulty stays the same
                    - **ğŸ˜° Too Hard** â†’ Next time will be easier

                    â±ï¸ Tasks are verified every 15 minutes, but you can also manually trigger verification by clicking on the "Verify All Tasks" button to see if you've completed any tasks and get real-time feedback on your progress!

# ========== TAB 4: COLLABORATIVE GOAL ==========
- title: Collaborative Goal
  path: collaborative
  icon: mdi:account-group
  type: panel
  cards:
    - type: vertical-stack
      cards:
        # --- CALIBRATION PHASE (LOCKED) ---
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: baseline
          card:
            type: markdown
            content: |
              ## ğŸ”’ Goal Locked

              ğŸ”§ The system is currently learning your building's baseline habits.

              **â³ Time Remaining:** {{ state_attr('sensor.research_phase', 'days_remaining') }} days

              *Once calibration is complete, your weekly energy challenges will appear here.* ğŸ¯

        # --- ACTIVE PHASE (UNLOCKED) ---
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: active
          card:
            type: vertical-stack
            cards:
              # DYNAMIC HEADER & STATUS
              - type: markdown
                content: |
                  # ğŸ¯ Week {{ state_attr('sensor.weekly_challenge_progress', 'week_start') }} Challenge

                  {% set current = state_attr('sensor.weekly_challenge_progress', 'current_avg_w') | float(0) %}
                  {% set target = state_attr('sensor.weekly_challenge_progress', 'target_avg_w') | float(0) %}
                  {% set pct = state_attr('sensor.weekly_challenge_progress', 'progress') | float(0) %}

                  {% if pct <= 100 %}
                  ### Status: âœ… On Track ({{ pct }}%)
                  Keep it up! The team is under the energy budget. ğŸ‰
                  {% else %}
                  ### Status: âš ï¸ At Risk ({{ pct }}%)
                  Action needed! We are exceeding the target average. ğŸš¨
                  {% endif %}

              # HERO GAUGE & MOTIVATION STACK
              - type: horizontal-stack
                cards:
                  # The Target Gauge
                  - type: gauge
                    entity: sensor.weekly_challenge_progress
                    name: Budget Used
                    min: 0
                    max: 150
                    unit: "%"
                    severity:
                      green: 0
                      yellow: 90
                      red: 105

                  # Calculated Monetary Incentive
                  - type: markdown
                    content: |
                      ### ğŸ† The Reward

                      {% set baseline = state_attr('sensor.weekly_challenge_progress', 'baseline_w') | float(0) %}
                      {% set target = state_attr('sensor.weekly_challenge_progress', 'target_avg_w') | float(0) %}
                      {% set price = states('input_number.electricity_price') | float(0.25) %}
                      {% set currency = states('input_select.currency') %}

                      {# Calculate Potential Weekly Savings: (Saved Watts * 24h * 7d / 1000) * Price #}
                      {% set potential_watts = baseline - target %}
                      {% set potential_eur = (potential_watts * 24 * 7 / 1000 * price) | round(2) %}

                      If you hit this target, you could save this week approximately:

                      # ğŸ’° {{ potential_eur }} {{ currency }}

                      *compared to your standard baseline week.*

              # STATS BAR
              - type: entities
                show_header_toggle: false
                entities:
                  - type: attribute
                    entity: sensor.weekly_challenge_progress
                    attribute: current_avg_w
                    name: Current Average Load
                    icon: mdi:flash
                    suffix: "W"
                  - type: attribute
                    entity: sensor.weekly_challenge_progress
                    attribute: target_avg_w
                    name: Target Average Load
                    icon: mdi:target
                    suffix: "W"

              # LIVE FOCUS AREAS
              - type: markdown
                content: |
                  ### ğŸ•µï¸â€â™‚ï¸ Live Focus Areas
                  *Where can the team help right now?* ğŸ¤”

                  {%- set sensors = state_attr('sensor.hardware_sensors', 'power') -%}
                  {%- set ns = namespace(area_sums={}, total=0) -%}

                  {# Aggregate Power by Area (Including 0W areas for accurate math) #}
                  {%- if sensors -%}
                    {%- for s in sensors -%}
                      {%- if s.value is not none -%}
                        {%- set area = s.area if s.area else 'Other' -%}
                        {%- set current = ns.area_sums.get(area, 0) -%}
                        {%- set ns.area_sums = dict(ns.area_sums, **{area: current + s.value}) -%}
                        {%- set ns.total = ns.total + s.value -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}

                  {# Calculate mean across ALL monitored areas #}
                  {%- set area_count = ns.area_sums | length -%}
                  {%- set mean = (ns.total / area_count) if area_count > 0 else 0 -%}
                  
                  {# Dynamic thresholds with an absolute minimum floor (e.g., 200W / 50W) #}
                  {%- set high_threshold = [mean * 1.5, 200] | max -%}
                  {%- set moderate_threshold = [mean * 0.7, 50] | max -%}

                  <table width="100%">
                  <thead>
                    <tr>
                      <th align="left">ğŸ“ Area</th>
                      <th align="right">âš¡ Current Load</th>
                      <th align="center">ğŸ“Š Status</th>
                    </tr>
                  </thead>
                  <tbody>
                  {%- for area, watts in ns.area_sums.items() | sort(attribute='1', reverse=True) -%}
                    {# Only show areas with actionable usage (e.g., > 10W) #}
                    {%- if watts > 10 -%}
                    <tr>
                      <td><b>{{ area }}</b></td>
                      <td align="right">{{ watts | int }} W</td>
                      <td align="center">{% if watts > high_threshold %}ğŸ”´ High{% elif watts > moderate_threshold %}ğŸŸ  Moderate{% else %}ğŸŸ¢ Low{% endif %}</td>
                    </tr>
                    {%- endif -%}
                  {%- endfor -%}
                  </tbody>
                  </table>

                  <small><i>ğŸ’¡ Check the "High" usage areas to see if lights or devices can be turned off!</i></small>

# ========== TAB 5: NOTIFICATIONS ==========
- title: Notifications
  path: notifications
  icon: mdi:bell
  type: panel
  cards:
    - type: vertical-stack
      cards:

        # --- LOCKED STATE (BASELINE) ---
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: baseline
          card:
            type: markdown
            content: |
              ## ğŸ”’ Notifications Locked

              We are currently learning your baseline habits.
              Smart alerts and nudges will be enabled in **{{ state_attr('sensor.research_phase', 'days_remaining') }} days**. â³

        # --- ACTIVE STATE (FULL UI) ---
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: active
          card:
            type: vertical-stack
            cards:
              # --- TOP SECTION (STATS & INSTRUCTIONS) ---
              - type: tile
                entity: sensor.active_notifications
                name: Active Alerts
                icon: mdi:bell-ring
                color: accent

              - type: markdown
                content: |
                  ### â„¹ï¸ How to Use
                  1. **ğŸ“– Read** the alert details below.
                  2. **ğŸƒ Act** to verify or fix the issue in your home.
                  3. **ğŸ”½ Select** the ID in the panel.
                  4. **ğŸ‘† Tap** Accept or Reject only *after* you have acted.

              # --- INBOX SECTION ---
              - type: markdown
                title: ğŸ“¬ Pending Inbox
                content: |
                  {%- set notifs = state_attr('sensor.active_notifications', 'notifications') -%}
                  {%- set safe_notifs = notifs if notifs else [] -%}
                  {%- set pending = safe_notifs | selectattr('responded', 'equalto', false) | list -%}

                  {%- if pending | length == 0 -%}
                  ### âœ… All Caught Up!
                  No pending alerts at the moment. ğŸ˜
                  {%- else -%}

                  {%- for n in pending -%}
                  ---
                  ### ğŸ“¢ {{ n.title }}
                  **ID:** `{{ n.notification_id }}` â€¢ **â° Time:** *{{ n.time_ago }}*

                  {{ n.message }}

                  {%- endfor -%}
                  {%- endif -%}

              # --- ACTION PANEL ---
              - type: vertical-stack
                cards:
                  - type: entities
                    title: ğŸ¬ Take Action
                    show_header_toggle: false
                    entities:
                      - entity: select.notification_selector
                        name: ğŸ”½ Select ID to Respond

                  - type: horizontal-stack
                    cards:
                      - type: tile
                        entity: select.notification_selector
                        name: Accept
                        icon: mdi:check
                        color: green
                        show_entity_picture: false
                        state_content: []
                        tap_action:
                          action: call-service
                          service: green_shift.respond_to_selection
                          data:
                            decision: accept

                      - type: tile
                        entity: select.notification_selector
                        name: Reject
                        icon: mdi:close
                        color: red
                        show_entity_picture: false
                        state_content: []
                        tap_action:
                          action: call-service
                          service: green_shift.respond_to_selection
                          data:
                            decision: reject

              # --- HISTORY TABLE ---
              - type: markdown
                title: ğŸ“œ History
                content: |
                  {%- set ns = state_attr('sensor.active_notifications', 'notifications') -%}
                  {%- if ns -%}
                  <table width="100%">
                    <thead>
                      <tr>
                        <th align="left">â° Time</th>
                        <th align="left">ğŸ“‹ Type</th>
                        <th align="center">ğŸ“Š Status</th>
                      </tr>
                    </thead>
                    <tbody>
                    {%- for n in ns[:8] -%}
                      <tr>
                        <td>{{ n.time_ago }}</td>
                        <td>{{ n.action_type | replace('_', ' ') | capitalize }}</td>
                        <td align="center">{{ n.status_emoji }}</td>
                      </tr>
                    {%- endfor -%}
                    </tbody>
                  </table>
                  {%- else -%}
                  ğŸ“­ No history available.
                  {%- endif -%}

# ========== TAB 6: USER PROFILE ==========
- title: Profile
  path: profile
  icon: mdi:account-circle
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: baseline
          card:
            type: markdown
            content: |
              ## ğŸš§ Profile Building...
              ğŸ”§ We are currently calibrating your baseline.
              Your personal eco-stats and levels will unlock in **{{ state_attr('sensor.research_phase', 'days_remaining') }} days**. â³

        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: active
          card:
            type: vertical-stack
            cards:
              # --- PLAYER LEVEL CARD ---
              - type: markdown
                content: |
                  {% set tasks = states('sensor.tasks_completed_today') | int %}
                  {% if tasks < 5 %}
                  # ğŸ£ Level 1: Novice
                  *Complete more daily tasks to evolve!* ğŸŒ±
                  {% elif tasks < 15 %}
                  # ğŸŒ¿ Level 2: Eco-Apprentice
                  *You're getting the hang of this!* ğŸ’ª
                  {% elif tasks < 30 %}
                  # ğŸŒ³ Level 3: Guardian
                  *Amazing dedication!* â­
                  {% else %}
                  # ğŸ‘‘ Level 4: Planet Master
                  *You are an energy saving legend.* ğŸ†
                  {% endif %}

                  ---
                  **ğŸ“Š Tasks Completed (Last 30 Days):** {{ tasks }}
                  <small>*Your level is based on completed tasks in the last 30 days*</small>

              # --- STREAKS ---
              - type: markdown
                content: |
                  ### ğŸ”¥ Your Streaks
                  {% set daily = states('sensor.daily_task_streak') | int(0) %}
                  {% set weekly = states('sensor.weekly_challenge_streak') | int(0) %}

                  | | Streak | Status |
                  |---|---|---|
                  | ğŸ”¥ Daily Tasks | **{{ daily }} day{% if daily != 1 %}s{% endif %}** | {{ 'â­ Unstoppable!' if daily >= 7 else ('ğŸ’ª Building!' if daily >= 3 else ('ğŸŒ± Good start!' if daily >= 1 else 'â–¶ï¸ Complete a task!')) }} |
                  | ğŸ† Weekly Goals | **{{ weekly }} week{% if weekly != 1 %}s{% endif %}** | {{ 'ğŸŒŸ Legendary!' if weekly >= 4 else ('ğŸ¯ On a roll!' if weekly >= 2 else ('ğŸ‰ First win!' if weekly >= 1 else 'ğŸ¯ Win this week!')) }} |

              - type: horizontal-stack
                cards:
                  - type: gauge
                    entity: sensor.behavior_index
                    name: ğŸ’ª Engagement
                    min: 0
                    max: 1
                    severity:
                      red: 0
                      yellow: 0.4
                      green: 0.8

                  - type: gauge
                    entity: sensor.fatigue_index
                    name: ğŸ˜´ Fatigue Risk
                    min: 0
                    max: 1
                    severity:
                      green: 0
                      yellow: 0.5
                      red: 0.8

              # --- TOTAL IMPACT GLANCE ---
              - type: glance
                title: ğŸŒŸ Lifetime Impact
                columns: 3
                entities:
                  - entity: sensor.accumulated_savings
                    name: ğŸ’° Money Saved
                  - entity: sensor.co2_saved
                    name: ğŸŒ± COâ‚‚ Avoided
                  - entity: sensor.weekly_challenge_progress
                    name: ğŸ¯ Current Goal

              # --- "DID YOU KNOW?" CONTEXT ---
              - type: markdown
                content: |
                  ### ğŸŒ Your Real-World Impact
                  {% set trees = state_attr('sensor.co2_saved', 'trees') | default(0) %}
                  {% set flights = state_attr('sensor.co2_saved', 'flights') | default(0) %}
                  {% set km = state_attr('sensor.co2_saved', 'car_km') | default(0) %}

                  Your savings so far are equivalent to:
                  * ğŸŒ² Planting **{{ trees }} mature trees**
                  * âœˆï¸ Offsetting **{{ flights }} short-haul flights**
                  * ğŸš— Avoiding **{{ km }} km** driven in a gas car

# ========== TAB 7: SETTINGS ==========
- title: Settings
  path: settings
  icon: mdi:cog
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: markdown
          content: |
            # âš™ï¸ System Configuration
            Manage your preferences, cost settings and view system health. ğŸ”§

        # --- SYSTEM STATUS (Read-Only) ---
        - type: entities
          title: ğŸ“Š System Status
          show_header_toggle: false
          state_color: true
          entities:
            - entity: sensor.research_phase
              name: Current Phase
              icon: mdi:flask-outline
              secondary_info: last-updated

            - entity: sensor.energy_baseline
              name: Learned Baseline
              icon: mdi:chart-bell-curve-cumulative

        # --- CONFIGURATION (User Inputs) ---
        - type: entities
          title: ğŸ›ï¸ Preferences & Costs
          show_header_toggle: false
          entities:
            # --- SECTION: GOALS ---
            - type: section
              label: "Energy Goals"

            - type: conditional
              conditions:
                - entity: sensor.research_phase
                  state: baseline
              row:
                type: attribute
                entity: sensor.research_phase
                attribute: days_remaining
                name: "Goals Locked (Calibration)"
                icon: mdi:lock-clock
                suffix: "days left"

            - type: conditional
              conditions:
                - entity: sensor.research_phase
                  state: active
              row:
                entity: input_number.energy_saving_target
                name: "Weekly Reduction Target (%)"
                icon: mdi:target

            # --- SECTION: ECONOMICS ---
            - type: section
              label: "Costs & Currency"

            - entity: input_select.currency
              name: ğŸ’µ Currency
              icon: mdi:cash-100

            - entity: input_number.electricity_price
              name: Electricity Price (per kWh)
              icon: mdi:lightning-bolt-circle

        # --- HELP FOOTER ---
        - type: markdown
          content: |
            ### â„¹ï¸ Quick Guide
            * **ğŸ”¬ Baseline Phase:** The system learns your normal usage for 14 days.
            * **ğŸ“‰ Reduction Target:** Once active, the system will set weekly challenges to reduce your consumption by this percentage.
            * **ğŸ’¡ Tips:** Adjust settings based on your energy goals and local electricity rates.
