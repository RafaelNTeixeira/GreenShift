# Green Shift - Dashboard em Portugu√™s
title: Green Shift
views:

# ========== TAB 1: DISPOSITIVOS ==========
- title: Dispositivos
  path: devices
  icon: mdi:power-plug
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: markdown
          content: |
            # üîå Dispositivos Monitorizados
            Valores em tempo real dos **sensores de hardware** descobertos automaticamente.
        # --- VIS√ÉO GLOBAL ---
        - type: grid
          columns: 2
          square: false
          cards:
            - type: vertical-stack
              cards:
                - type: sensor
                  entity: sensor.current_consumption
                  name: ‚ö° Carga Total
                  graph: line
                - type: markdown
                  content: >
                    <p style="margin: -12px 16px 8px; font-size: 12px; color: var(--secondary-text-color);">Pot√™ncia instant√¢nea a ser consumida agora (W)</p>
            - type: vertical-stack
              cards:
                - type: sensor
                  entity: sensor.current_cost_per_hour
                  name: üíµ Custo por Hora
                  graph: line
                - type: markdown
                  content: >
                    <p style="margin: -12px 16px 8px; font-size: 12px; color: var(--secondary-text-color);">Custo estimado √† taxa de consumo atual</p>
            - type: vertical-stack
              cards:
                - type: sensor
                  entity: sensor.daily_cost
                  name: üí∞ Custo Di√°rio
                  graph: line
                - type: markdown
                  content: >
                    <p style="margin: -12px 16px 8px; font-size: 12px; color: var(--secondary-text-color);">Custo total de energia acumulado hoje</p>
            - type: vertical-stack
              cards:
                - type: sensor
                  entity: sensor.daily_co2_estimate
                  name: üå± CO2 Di√°rio
                  graph: line
                - type: markdown
                  content: >
                    <p style="margin: -12px 16px 8px; font-size: 12px; color: var(--secondary-text-color);">Emiss√µes de CO‚ÇÇ estimadas do uso de energia de hoje (kg)</p>

        # --- DASHBOARD DIN√ÇMICO POR √ÅREA ---
        - type: vertical-stack
          cards:
            # Filtro de Entrada
            - type: entities
              entities:
                - entity: select.dashboard_area_filter
                  name: Filtrar por Divis√£o
                  icon: mdi:filter-variant
              style: |
                ha-card {
                  box-shadow: none;
                  background: none;
                  margin-bottom: -15px;
                }

            - type: markdown
              content: |
                {%- set filter = states('select.dashboard_area_filter') -%}
                {%- set ns = namespace(areas=[]) -%}
                {%- set cats = ['power', 'energy', 'temperature', 'humidity', 'illuminance', 'occupancy'] -%}

                {# --- 1. Coletar √Åreas √önicas --- #}
                {%- for c in cats -%}
                  {%- set sensors = state_attr('sensor.hardware_sensors', c) -%}
                  {%- if sensors and sensors is iterable -%}
                    {%- for s in sensors -%}
                      {%- set area = s.get('area', 'Sem Atribui√ß√£o') -%}
                      {%- if area and area not in ns.areas -%}
                        {%- set ns.areas = ns.areas + [area] -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}
                {%- endfor -%}

                {# --- 2. Renderizar Tabelas por √Årea --- #}
                {%- if ns.areas | length == 0 -%}
                  <p style="text-align: center;">‚ö†Ô∏è <b>Nenhum sensor ou √°rea detetada.</b></p>
                {%- else -%}
                  {%- for area in ns.areas | sort -%}
                    {# Verificar Filtro #}
                    {%- if filter in ['All Areas', 'Todas as √Åreas', 'unknown', 'unavailable', 'None'] or filter == area -%}

                      <h3>üìç {{ area }}</h3>
                      <table width="100%">
                      {%- for c in cats -%}
                        {%- set sensors = state_attr('sensor.hardware_sensors', c) -%}
                        {%- if sensors and sensors is iterable -%}
                          {%- for s in sensors -%}
                            {%- if s.get('area', 'Sem Atribui√ß√£o') == area -%}
                              <tr>
                                <td width="30px">
                                  <ha-icon icon="{{ 'mdi:lightning-bolt' if c == 'power' else 'mdi:counter' if c == 'energy' else 'mdi:thermometer' if c == 'temperature' else 'mdi:water-percent' if c == 'humidity' else 'mdi:brightness-5' if c == 'illuminance' else 'mdi:eye' }}" style="width: 20px; color: var(--secondary-text-color);"></ha-icon>
                                </td>
                                <td>{{ s.name }}</td>
                                <td align="right">
                                  {%- if c == 'occupancy' -%}
                                    {{ 'Ocupado üî¥' if s.value == 'on' else 'Livre üü¢' }}
                                  {%- else -%}
                                    <b>{{ s.value }}</b> <small>{{ s.unit }}</small>
                                  {%- endif -%}
                                </td>
                              </tr>
                            {%- endif -%}
                          {%- endfor -%}
                        {%- endif -%}
                      {%- endfor -%}
                      </table>
                      <hr style="border: 0; border-bottom: 1px solid var(--divider-color); margin: 15px 0;">

                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}

        # --- LEGENDA ---
        - type: markdown
          content: |
            ### üìò Guia R√°pido
            {% set p = state_attr('sensor.hardware_sensors', 'power') %}
            {% set e = state_attr('sensor.hardware_sensors', 'energy') %}
            {% set l = state_attr('sensor.hardware_sensors', 'illuminance') %}
            {% set h = state_attr('sensor.hardware_sensors', 'humidity') %}

            {% if p and p | length > 0 %}
            **‚ö° Pot√™ncia (Watts):** *O "Veloc√≠metro"*
            > Mostra quanta eletricidade est√° a usar **neste momento**.
            > *Dica:* Se este valor estiver alto, um aparelho "pesado" como o Forno ou AC est√° ligado.

            ---
            {% endif %}

            {% if e and e | length > 0 %}
            **üîã Energia (kWh):** *O "Contador"*
            > A quantidade total usada ao longo do tempo. Isto √© o que aparece na sua **Conta de Luz**.
            > *Escala:* **1 unidade (kWh)** equivale aproximadamente a uma carga completa de roupa.

            ---
            {% endif %}

            {% if l and l | length > 0 %}
            **üí° Luz (Lux):** *Luminosidade*
            > Mede o qu√£o brilhante est√° a divis√£o.
            > *Escala:* **0** (Escuro Total) ‚Üí **150** (Sala T√≠pica) ‚Üí **500+** (Escrit√≥rio Luminoso).

            ---
            {% endif %}

            {% if h and h | length > 0 %}
            **üíß Humidade:** *Humidade do Ar*
            > **40-60%** √© a "Zona de Conforto."
            > *Aviso:* Acima de **70%** sente-se "abafado" e h√° risco de bolor; abaixo de **30%** sente-se muito seco.
            {% endif %}

# ========== TAB 2: DASHBOARD ==========
- title: Dashboard
  path: dashboard
  icon: mdi:chart-line
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: markdown
          content: |
            # üìä Dashboard
            Analise os seus padr√µes de consumo de energia e identifique oportunidades de poupan√ßa.

        # --- SEC√á√ÉO DE GR√ÅFICO ---
        - type: vertical-stack
          cards:
            - type: markdown
              content: |
                ### üìà Desempenho vs. Baseline
                <div style="background: var(--card-background-color); border: 1px solid var(--divider-color); padding: 10px; border-radius: 6px; font-size: 13px; color: var(--secondary-text-color); margin-bottom: 0px;">
                  ‚ÑπÔ∏è <b>O que √© "Consumo Baseline"?</b><br>
                  Esta linha representa o seu consumo m√©dio de energia. Ser√° ajustada ao longo do tempo.
                </div>

            - type: history-graph
              hours_to_show: 168
              entities:
                - entity: sensor.current_consumption
                  name: Uso Atual
                - entity: sensor.energy_baseline
                  name: Consumo Baseline

        # --- TABELA DE CONSUMO POR √ÅREA ---
        - type: markdown
          content: |
            ### ‚ö° Uso de Energia por √Årea

            {%- set sensors = state_attr('sensor.hardware_sensors', 'power') -%}
            {%- set ns = namespace(area_sums={}, total=0) -%}

            {%- if sensors -%}
              {%- for s in sensors -%}
                {%- if s.value is not none -%}
                  {%- set ns.total = ns.total + s.value -%}
                  {%- set area = s.area if s.area else 'Sem √Årea' -%}
                  {%- set current = ns.area_sums.get(area, 0) -%}
                  {%- set new_dict = {area: current + s.value} -%}
                  {%- set ns.area_sums = dict(ns.area_sums, **new_dict) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}

            {%- if ns.total == 0 -%}
            </br>
            üì≠ Nenhum dado de √°rea recolhido.
            {%- else -%}

            </br>

            <table width="100%">
              <thead>
                <tr>
                  <th style="text-align: left;">üìç √Årea</th>
                  <th style="text-align: right;">‚ö° Uso</th>
                  <th style="text-align: right;">üìä Quota</th>
                  <th style="text-align: left;">üìä Distribui√ß√£o</th>
                </tr>
              </thead>
              <tbody>
              {%- for area, w in ns.area_sums.items() | sort(attribute='1', reverse=True) -%}
                {%- set pct = (w / ns.total * 100) | round(0) | int -%}
                {%- set blocks = (pct / 10) | round(0) | int -%}
                {%- set bar = '‚ñà' * blocks + '‚ñë' * (10 - blocks) -%}
                <tr>
                  <td style="text-align: left;"><b>{{ area }}</b></td>
                  <td style="text-align: right;">{{ w | round(2) }} W</td>
                  <td style="text-align: right;">{{ pct }}%</td>
                  <td style="text-align: left; color: var(--primary-color);">{{ bar }}</td>
                </tr>
              {%- endfor -%}
              </tbody>
            </table>
            {%- endif -%}

        # --- TOP 5 CONSUMIDORES ---
        - type: markdown
          content: |
            ### üèÜ Top 5 Consumidores de Energia
            {%- set sensors = state_attr('sensor.hardware_sensors', 'power') -%}
            {%- if sensors -%}
            {%- set top_devices = sensors
                | selectattr('value', 'ne', None)
                | sort(attribute='value', reverse=True)
                | list
            -%}
            {%- set max_val = top_devices[0].value if (top_devices and top_devices[0].value > 0) else 1 -%}
            </br>
            <table width="100%">
              <thead>
                <tr>
                  <th style="text-align: left;">üîå Dispositivo</th>
                  <th style="text-align: right;">‚ö° Carga</th>
                  <th style="text-align: left; padding-left: 10px;">üìä Impacto</th>
                </tr>
              </thead>
              <tbody>
                {%- for s in top_devices[:5] -%}
                {%- set pct = (s.value / max_val * 100) | int -%}
                {%- set blocks = (pct / 10) | round(0) | int -%}
                {%- set bar = '‚ñà' * blocks + '‚ñë' * (10 - blocks) -%}
                <tr>
                  <td style="text-align: left;">{{ s.name }}</td>
                  <td style="text-align: right;"><b>{{ s.value }} W</b></td>
                  <td style="text-align: left; padding-left: 10px; color: var(--primary-color);">
                    {{ bar }}
                  </td>
                </tr>
                {%- endfor -%}
              </tbody>
            </table>
            {%- else -%}
            </br>
            üò¥ Nenhum dispositivo ativo detetado.
            {%- endif -%}

# ========== TAB 3: DESAFIOS ==========
- title: Desafios
  path: tasks
  icon: mdi:clipboard-check
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: baseline
          card:
            type: markdown
            content: |
              ## üîí Desafios Bloqueados
              **{{ state_attr('sensor.research_phase', 'days_remaining') }} dias** at√© desbloquear ‚è≥

        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: active
          card:
            type: vertical-stack
            cards:
              - type: markdown
                content: |
                  # üìÖ Desafios Di√°rios de Energia
                  {% set verified = state_attr('sensor.daily_tasks', 'verified_count') | default(0) %}
                  {% set total = state_attr('sensor.daily_tasks', 'total_count') | default(0) %}
                  {% if total > 0 %}
                  ‚úÖ **{{ verified }}/{{ total }}** tarefas verificadas hoje
                  {% else %}
                  üì≠ Sem tarefas dispon√≠veis para hoje.
                  {% endif %}

              # Card Tarefa 1
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 0
                card:
                  type: vertical-stack
                  cards:
                    - type: horizontal-stack
                      cards:
                        - type: markdown
                          content: |
                            {% set tasks = state_attr('sensor.daily_tasks', 'tasks') %}
                            {% if tasks and tasks | length > 0 %}
                            {% set t = tasks[0] %}

                            ### {{ t.status_emoji }} Tarefa 1: {{ t.title }}

                            {{ t.description }}

                            **Meta:** {{ t.target_value }}{{ t.target_unit }} (de {{ t.baseline_value }}{{ t.target_unit }})
                            **üìä Dificuldade:** {{ t.difficulty_display }}
                            {% if t.area_name %}**üìç √Årea:** {{ t.area_name }}{% endif %}

                            {% if t.verified %}
                            ‚úÖ **VERIFICADA!** Atingiu a meta!
                            {% else %}
                            üéØ **Ativa** - Complete hoje!
                            {% endif %}
                            {% endif %}

                    - type: horizontal-stack
                      cards:
                        - type: button
                          name: Muito F√°cil
                          icon: mdi:emoticon-happy-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 0
                              feedback: too_easy
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Adequada
                          icon: mdi:emoticon-neutral-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 0
                              feedback: just_right
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Muito Dif√≠cil
                          icon: mdi:emoticon-sad-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 0
                              feedback: too_hard
                          entity: sensor.daily_tasks
                          show_state: false

              # Card Tarefa 2
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 1
                card:
                  type: vertical-stack
                  cards:
                    - type: horizontal-stack
                      cards:
                        - type: markdown
                          content: |
                            {% set tasks = state_attr('sensor.daily_tasks', 'tasks') %}
                            {% if tasks and tasks | length > 1 %}
                            {% set t = tasks[1] %}

                            ---

                            ### {{ t.status_emoji }} Tarefa 2: {{ t.title }}

                            {{ t.description }}

                            **üéØ Meta:** {{ t.target_value }}{{ t.target_unit }} (de {{ t.baseline_value }}{{ t.target_unit }})
                            **üìä Dificuldade:** {{ t.difficulty_display }}
                            {% if t.area_name %}**üìç √Årea:** {{ t.area_name }}{% endif %}

                            {% if t.verified %}
                            ‚úÖ **VERIFICADA!** Atingiu a meta!
                            {% else %}
                            üéØ **Ativa** - Complete hoje!
                            {% endif %}
                            {% endif %}

                    - type: horizontal-stack
                      cards:
                        - type: button
                          name: Muito F√°cil
                          icon: mdi:emoticon-happy-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 1
                              feedback: too_easy
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Adequada
                          icon: mdi:emoticon-neutral-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 1
                              feedback: just_right
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Muito Dif√≠cil
                          icon: mdi:emoticon-sad-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 1
                              feedback: too_hard
                          entity: sensor.daily_tasks
                          show_state: false

              # Card Tarefa 3
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 2
                card:
                  type: vertical-stack
                  cards:
                    - type: horizontal-stack
                      cards:
                        - type: markdown
                          content: |
                            {% set tasks = state_attr('sensor.daily_tasks', 'tasks') %}
                            {% if tasks and tasks | length > 2 %}
                            {% set t = tasks[2] %}

                            ---

                            ### {{ t.status_emoji }} Tarefa 3: {{ t.title }}

                            {{ t.description }}

                            **üéØ Meta:** {{ t.target_value }}{{ t.target_unit }} (de {{ t.baseline_value }}{{ t.target_unit }})
                            **üìä Dificuldade:** {{ t.difficulty_display }}
                            {% if t.area_name %}**üìç √Årea:** {{ t.area_name }}{% endif %}

                            {% if t.verified %}
                            ‚úÖ **VERIFICADA!** Atingiu a meta!
                            {% else %}
                            üéØ **Ativa** - Complete hoje!
                            {% endif %}
                            {% endif %}

                    - type: horizontal-stack
                      cards:
                        - type: button
                          name: Muito F√°cil
                          icon: mdi:emoticon-happy-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 2
                              feedback: too_easy
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Adequada
                          icon: mdi:emoticon-neutral-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 2
                              feedback: just_right
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Muito Dif√≠cil
                          icon: mdi:emoticon-sad-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 2
                              feedback: too_hard
                          entity: sensor.daily_tasks
                          show_state: false

              # Bot√£o Verificar Todas as Tarefas
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 0
                card:
                  type: button
                  name: "Verificar Todas as Tarefas"
                  icon: mdi:check-circle
                  icon_height: 30px
                  tap_action:
                    action: call-service
                    service: green_shift.verify_tasks
                  show_state: false

              # Resumo
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 0
                card:
                  type: markdown
                  content: |
                    ---
                    ### üí° Como Funciona o Feedback

                    Avalie a dificuldade de cada tarefa para ajudar o sistema a ajustar desafios futuros:
                    - **üòä Muito F√°cil** ‚Üí Pr√≥xima vez ser√° mais dif√≠cil
                    - **üòê Adequada** ‚Üí Dificuldade mant√©m-se igual
                    - **üò∞ Muito Dif√≠cil** ‚Üí Pr√≥xima vez ser√° mais f√°cil

                    ‚è±Ô∏è As tarefas s√£o verificadas de 15 em 15 minutos, mas tamb√©m pode acionar manualmente a verifica√ß√£o clicando no bot√£o "Verificar Todas as Tarefas" para ver se completou alguma tarefa e obter feedback em tempo real!

# ========== TAB 4: META COLABORATIVA ==========
- title: Meta Colaborativa
  path: collaborative
  icon: mdi:account-group
  type: panel
  cards:
    - type: vertical-stack
      cards:
        # --- FASE DE CALIBRA√á√ÉO (BLOQUEADA) ---
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: baseline
          card:
            type: markdown
            content: |
              ## üîí Meta Bloqueada

              üîß O sistema est√° atualmente a aprender os h√°bitos baseline do edif√≠cio.

              **‚è≥ Tempo Restante:** {{ state_attr('sensor.research_phase', 'days_remaining') }} dias

              *Assim que a calibra√ß√£o estiver completa, os seus desafios semanais de energia aparecer√£o aqui.* üéØ

        # --- FASE ATIVA (DESBLOQUEADA) ---
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: active
          card:
            type: vertical-stack
            cards:
              # CABE√áALHO DIN√ÇMICO & ESTADO
              - type: markdown
                content: |
                  # üéØ Desafio Semana {{ state_attr('sensor.weekly_challenge_progress', 'week_start') }}

                  {% set current = state_attr('sensor.weekly_challenge_progress', 'current_avg_w') | float(0) %}
                  {% set target = state_attr('sensor.weekly_challenge_progress', 'target_avg_w') | float(0) %}
                  {% set pct = state_attr('sensor.weekly_challenge_progress', 'progress') | float(0) %}

                  {% if pct <= 100 %}
                  ### Estado: ‚úÖ No Caminho Certo ({{ pct }}%)
                  Continue assim! A equipa est√° abaixo do or√ßamento de energia. üéâ
                  {% else %}
                  ### Estado: ‚ö†Ô∏è Em Risco ({{ pct }}%)
                  A√ß√£o necess√°ria! Estamos a exceder a m√©dia alvo. üö®
                  {% endif %}

              # INDICADOR & MOTIVA√á√ÉO
              - type: horizontal-stack
                cards:
                  # Indicador da Meta
                  - type: gauge
                    entity: sensor.weekly_challenge_progress
                    name: Or√ßamento Usado
                    min: 0
                    max: 150
                    unit: "%"
                    severity:
                      green: 0
                      yellow: 90
                      red: 105

                  # Incentivo Monet√°rio Calculado
                  - type: markdown
                    content: |
                      ### üèÜ A Recompensa

                      {% set baseline = state_attr('sensor.weekly_challenge_progress', 'baseline_w') | float(0) %}
                      {% set target = state_attr('sensor.weekly_challenge_progress', 'target_avg_w') | float(0) %}
                      {% set price = states('input_number.electricity_price') | float(0.25) %}
                      {% set currency = states('input_select.currency') %}

                      {# Calcular Poupan√ßas Semanais Potenciais: (Watts Poupados * 24h * 7d / 1000) * Pre√ßo #}
                      {% set potential_watts = baseline - target %}
                      {% set potential_eur = (potential_watts * 24 * 7 / 1000 * price) | round(2) %}

                      Se atingir esta meta, poder√° poupar esta semana aproximadamente:

                      # üí∞ {{ potential_eur }} {{ currency }}

                      *comparado com a sua semana baseline padr√£o.*

              # BARRA DE ESTAT√çSTICAS
              - type: entities
                show_header_toggle: false
                entities:
                  - type: attribute
                    entity: sensor.weekly_challenge_progress
                    attribute: current_avg_w
                    name: Carga M√©dia Atual
                    icon: mdi:flash
                    suffix: "W"
                  - type: attribute
                    entity: sensor.weekly_challenge_progress
                    attribute: target_avg_w
                    name: Carga M√©dia Alvo
                    icon: mdi:target
                    suffix: "W"

              # √ÅREAS DE FOCO AO VIVO
              - type: markdown
                content: |
                  ### üïµÔ∏è‚Äç‚ôÇÔ∏è √Åreas de Foco ao Vivo
                  *Onde a equipa pode ajudar agora?* ü§î

                  {%- set sensors = state_attr('sensor.hardware_sensors', 'power') -%}
                  {%- set ns = namespace(area_sums={}, total=0) -%}

                  {# Agregar Pot√™ncia por √Årea (Incluindo √°reas 0W para c√°lculo preciso) #}
                  {%- if sensors -%}
                    {%- for s in sensors -%}
                      {%- if s.value is not none -%}
                        {%- set area = s.area if s.area else 'Outro' -%}
                        {%- set current = ns.area_sums.get(area, 0) -%}
                        {%- set ns.area_sums = dict(ns.area_sums, **{area: current + s.value}) -%}
                        {%- set ns.total = ns.total + s.value -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}

                  {# Calcular m√©dia entre TODAS as √°reas monitorizadas #}
                  {%- set area_count = ns.area_sums | length -%}
                  {%- set mean = (ns.total / area_count) if area_count > 0 else 0 -%}
                  
                  {# Limiares din√¢micos com um m√≠nimo absoluto (ex: 200W / 50W) #}
                  {%- set high_threshold = [mean * 1.5, 200] | max -%}
                  {%- set moderate_threshold = [mean * 0.7, 50] | max -%}

                  <table width="100%">
                  <thead>
                    <tr>
                      <th align="left">üìç √Årea</th>
                      <th align="right">‚ö° Carga Atual</th>
                      <th align="center">üìä Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                  {%- for area, watts in ns.area_sums.items() | sort(attribute='1', reverse=True) -%}
                    {# Mostrar apenas √°reas com uso acion√°vel (ex: > 10W) #}
                    {%- if watts > 10 -%}
                    <tr>
                      <td><b>{{ area }}</b></td>
                      <td align="right">{{ watts | int }} W</td>
                      <td align="center">{% if watts > high_threshold %}üî¥ Alto{% elif watts > moderate_threshold %}üü† Moderado{% else %}üü¢ Baixo{% endif %}</td>
                    </tr>
                    {%- endif -%}
                  {%- endfor -%}
                  </tbody>
                  </table>

                  <small><i>üí° Verifique as √°reas com uso "Alto" para ver se pode desligar luzes ou dispositivos!</i></small>

# ========== TAB 5: NOTIFICA√á√ïES ==========
- title: Notifica√ß√µes
  path: notifications
  icon: mdi:bell
  type: panel
  cards:
    - type: vertical-stack
      cards:

        # --- ESTADO BLOQUEADO (BASELINE) ---
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: baseline
          card:
            type: markdown
            content: |
              ## üîí Notifica√ß√µes Bloqueadas

              Estamos atualmente a aprender os seus h√°bitos baseline.
              Alertas inteligentes e nudges ser√£o ativados em **{{ state_attr('sensor.research_phase', 'days_remaining') }} dias**. ‚è≥

        # --- ESTADO ATIVO (UI COMPLETA) ---
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: active
          card:
            type: vertical-stack
            cards:
              # --- SEC√á√ÉO SUPERIOR (ESTAT√çSTICAS & INSTRU√á√ïES) ---
              - type: tile
                entity: sensor.active_notifications
                name: Alertas Ativos
                icon: mdi:bell-ring
                color: accent

              - type: markdown
                content: |
                  ### ‚ÑπÔ∏è Como Usar
                  1. **üìñ Leia** os detalhes do alerta abaixo.
                  2. **üèÉ Aja** para verificar ou corrigir o problema em sua casa.
                  3. **üîΩ Selecione** o ID no painel.
                  4. **üëÜ Toque** em Aceitar ou Rejeitar apenas *depois* de ter agido.

              # --- SEC√á√ÉO INBOX ---
              - type: markdown
                title: üì¨ Inbox Pendente
                content: |
                  {%- set notifs = state_attr('sensor.active_notifications', 'notifications') -%}
                  {%- set safe_notifs = notifs if notifs else [] -%}
                  {%- set pending = safe_notifs | selectattr('responded', 'equalto', false) | list -%}

                  {%- if pending | length == 0 -%}
                  ### ‚úÖ Tudo em Dia!
                  Sem alertas pendentes no momento. üòé
                  {%- else -%}

                  {%- for n in pending -%}
                  ---
                  ### üì¢ {{ n.title }}
                  **ID:** `{{ n.notification_id }}` ‚Ä¢ **‚è∞ Tempo:** *{{ n.time_ago }}*

                  {{ n.message }}

                  {%- endfor -%}
                  {%- endif -%}

              # --- PAINEL DE A√á√ÉO ---
              - type: vertical-stack
                cards:
                  - type: entities
                    title: üé¨ Tomar A√ß√£o
                    show_header_toggle: false
                    entities:
                      - entity: select.notification_selector
                        name: üîΩ Selecione o ID para Responder

                  - type: horizontal-stack
                    cards:
                      - type: tile
                        entity: select.notification_selector
                        name: Aceitar
                        icon: mdi:check
                        color: green
                        show_entity_picture: false
                        state_content: []
                        tap_action:
                          action: call-service
                          service: green_shift.respond_to_selection
                          data:
                            decision: accept

                      - type: tile
                        entity: select.notification_selector
                        name: Rejeitar
                        icon: mdi:close
                        color: red
                        show_entity_picture: false
                        state_content: []
                        tap_action:
                          action: call-service
                          service: green_shift.respond_to_selection
                          data:
                            decision: reject

              # --- TABELA HIST√ìRICO ---
              - type: markdown
                title: üìú Hist√≥rico
                content: |
                  {%- set ns = state_attr('sensor.active_notifications', 'notifications') -%}
                  {%- if ns -%}
                  <table width="100%">
                    <thead>
                      <tr>
                        <th align="left">‚è∞ Tempo</th>
                        <th align="left">üìã Tipo</th>
                        <th align="center">üìä Estado</th>
                      </tr>
                    </thead>
                    <tbody>
                    {%- for n in ns[:8] -%}
                      <tr>
                        <td>{{ n.time_ago }}</td>
                        <td>{{ n.action_type | replace('_', ' ') | capitalize }}</td>
                        <td align="center">{{ n.status_emoji }}</td>
                      </tr>
                    {%- endfor -%}
                    </tbody>
                  </table>
                  {%- else -%}
                  üì≠ Sem hist√≥rico dispon√≠vel.
                  {%- endif -%}

# ========== TAB 6: PERFIL ==========
- title: Perfil
  path: profile
  icon: mdi:account-circle
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: baseline
          card:
            type: markdown
            content: |
              ## üöß Perfil em Constru√ß√£o...
              üîß Estamos atualmente a calibrar o seu baseline.
              As suas estat√≠sticas ecol√≥gicas pessoais e n√≠veis ser√£o desbloqueados em **{{ state_attr('sensor.research_phase', 'days_remaining') }} dias**. ‚è≥

        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: active
          card:
            type: vertical-stack
            cards:
              # --- CARD N√çVEL DO JOGADOR ---
              - type: markdown
                content: |
                  {% set tasks = states('sensor.tasks_completed_today') | int %}
                  {% if tasks < 5 %}
                  # üê£ N√≠vel 1: Principiante
                  *Complete mais tarefas di√°rias para evoluir!* üå±
                  {% elif tasks < 15 %}
                  # üåø N√≠vel 2: Aprendiz Ecol√≥gico
                  *Est√° a perceber o sistema!* üí™
                  {% elif tasks < 30 %}
                  # üå≥ N√≠vel 3: Guardi√£o
                  *Dedica√ß√£o incr√≠vel!* ‚≠ê
                  {% else %}
                  # üëë N√≠vel 4: Mestre Planet√°rio
                  *√â uma lenda da poupan√ßa de energia.* üèÜ
                  {% endif %}

                  ---
                  **üìä Tarefas Completadas (√öltimos 30 Dias):** {{ tasks }}
                  <small>*O seu n√≠vel baseia-se nas tarefas completadas nos √∫ltimos 30 dias*</small>

              # --- INDICADORES DE ESTAT√çSTICAS RPG ---
              - type: horizontal-stack
                cards:
                  - type: gauge
                    entity: sensor.behavior_index
                    name: üí™ Compromisso
                    min: 0
                    max: 1
                    severity:
                      red: 0
                      yellow: 0.4
                      green: 0.8

                  - type: gauge
                    entity: sensor.fatigue_index
                    name: üò¥ Risco de Fadiga
                    min: 0
                    max: 1
                    severity:
                      green: 0
                      yellow: 0.5
                      red: 0.8

              # --- RESUMO DE IMPACTO TOTAL ---
              - type: glance
                title: üåü Impacto Total
                columns: 3
                entities:
                  - entity: sensor.accumulated_savings
                    name: üí∞ Dinheiro Poupado
                  - entity: sensor.co2_saved
                    name: üå± CO‚ÇÇ Evitado
                  - entity: sensor.weekly_challenge_progress
                    name: üéØ Meta Atual

              # --- CONTEXTO "SABIA QUE?" ---
              - type: markdown
                content: |
                  ### üåç O Seu Impacto no Mundo Real
                  {% set trees = state_attr('sensor.co2_saved', 'trees') | default(0) %}
                  {% set flights = state_attr('sensor.co2_saved', 'flights') | default(0) %}
                  {% set km = state_attr('sensor.co2_saved', 'car_km') | default(0) %}

                  As suas poupan√ßas at√© agora equivalem a:
                  * üå≤ Plantar **{{ trees }} √°rvores maduras**
                  * ‚úàÔ∏è Compensar **{{ flights }} voos de curta dist√¢ncia**
                  * üöó Evitar **{{ km }} km** conduzidos num carro a gasolina

# ========== TAB 7: DEFINI√á√ïES ==========
- title: Defini√ß√µes
  path: settings
  icon: mdi:cog
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: markdown
          content: |
            # ‚öôÔ∏è Configura√ß√£o do Sistema
            Gerir as suas prefer√™ncias, configura√ß√µes de custos e ver a sa√∫de do sistema. üîß

        # --- ESTADO DO SISTEMA (Apenas Leitura) ---
        - type: entities
          title: üìä Estado do Sistema
          show_header_toggle: false
          state_color: true
          entities:
            - entity: sensor.research_phase
              name: Fase Atual
              icon: mdi:flask-outline
              secondary_info: last-updated

            - entity: sensor.energy_baseline
              name: Baseline Aprendida
              icon: mdi:chart-bell-curve-cumulative

        # --- CONFIGURA√á√ÉO (Inputs de Utilizador) ---
        - type: entities
          title: üéõÔ∏è Prefer√™ncias & Custos
          show_header_toggle: false
          entities:
            # --- SEC√á√ÉO: METAS ---
            - type: section
              label: "Metas de Energia"

            - type: conditional
              conditions:
                - entity: sensor.research_phase
                  state: baseline
              row:
                type: attribute
                entity: sensor.research_phase
                attribute: days_remaining
                name: "Metas Bloqueadas (Calibra√ß√£o)"
                icon: mdi:lock-clock
                suffix: "dias restantes"

            - type: conditional
              conditions:
                - entity: sensor.research_phase
                  state: active
              row:
                entity: input_number.energy_saving_target
                name: "Meta de Redu√ß√£o Semanal (%)"
                icon: mdi:target

            # --- SEC√á√ÉO: ECON√ìMICA ---
            - type: section
              label: "Custos & Moeda"

            - entity: input_select.currency
              name: üíµ Moeda
              icon: mdi:cash-100

            - entity: input_number.electricity_price
              name: Pre√ßo da Eletricidade (por kWh)
              icon: mdi:lightning-bolt-circle

        # --- RODAP√â DE AJUDA ---
        - type: markdown
          content: |
            ### ‚ÑπÔ∏è Guia R√°pido
            * **üî¨ Fase Baseline:** O sistema aprende o seu uso normal durante 14 dias.
            * **üìâ Meta de Redu√ß√£o:** Uma vez ativo, o sistema definir√° desafios semanais para reduzir o seu consumo nesta percentagem.
            * **üí° Dicas:** Ajuste as configura√ß√µes com base nos seus objetivos energ√©ticos e tarifas locais de eletricidade.
