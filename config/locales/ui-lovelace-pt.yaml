# Green Shift - Dashboard em PortuguÃªs
title: Green Shift
views:

# ========== TAB 1: DISPOSITIVOS ==========
- title: Dispositivos
  path: devices
  icon: mdi:power-plug
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: markdown
          content: |
            # ğŸ”Œ Dispositivos Monitorizados
            Valores em tempo real dos **sensores de hardware** descobertos automaticamente.
        # --- VISÃƒO GLOBAL ---
        - type: grid
          columns: 2
          square: false
          cards:
            - type: vertical-stack
              cards:
                - type: sensor
                  entity: sensor.current_consumption
                  name: âš¡ Carga Total
                  graph: line
                - type: markdown
                  content: >
                    <p style="margin: -12px 16px 8px; font-size: 12px; color: var(--secondary-text-color);">PotÃªncia instantÃ¢nea a ser consumida agora (W)</p>
            - type: vertical-stack
              cards:
                - type: sensor
                  entity: sensor.current_cost_per_hour
                  name: ğŸ’µ Custo por Hora
                  graph: line
                - type: markdown
                  content: >
                    <p style="margin: -12px 16px 8px; font-size: 12px; color: var(--secondary-text-color);">Custo estimado Ã  taxa de consumo atual</p>
            - type: vertical-stack
              cards:
                - type: sensor
                  entity: sensor.daily_cost
                  name: ğŸ’° Custo DiÃ¡rio
                  graph: line
                - type: markdown
                  content: >
                    <p style="margin: -12px 16px 8px; font-size: 12px; color: var(--secondary-text-color);">Custo total de energia acumulado hoje</p>
            - type: vertical-stack
              cards:
                - type: sensor
                  entity: sensor.daily_co2_estimate
                  name: ğŸŒ± CO2 DiÃ¡rio
                  graph: line
                - type: markdown
                  content: >
                    <p style="margin: -12px 16px 8px; font-size: 12px; color: var(--secondary-text-color);">EmissÃµes de COâ‚‚ estimadas do uso de energia de hoje (kg)</p>

        # --- DASHBOARD DINÃ‚MICO POR ÃREA ---
        - type: vertical-stack
          cards:
            # Filtro de Entrada
            - type: entities
              entities:
                - entity: select.dashboard_area_filter
                  name: Filtrar por DivisÃ£o
                  icon: mdi:filter-variant
              style: |
                ha-card {
                  box-shadow: none;
                  background: none;
                  margin-bottom: -15px;
                }

            - type: markdown
              content: |
                {%- set filter = states('select.dashboard_area_filter') -%}
                {%- set ns = namespace(areas=[]) -%}
                {%- set cats = ['power', 'energy', 'temperature', 'humidity', 'illuminance', 'occupancy'] -%}

                {# --- 1. Coletar Ãreas Ãšnicas --- #}
                {%- for c in cats -%}
                  {%- set sensors = state_attr('sensor.hardware_sensors', c) -%}
                  {%- if sensors and sensors is iterable -%}
                    {%- for s in sensors -%}
                      {%- set area = s.get('area', 'Sem AtribuiÃ§Ã£o') -%}
                      {%- if area and area not in ns.areas -%}
                        {%- set ns.areas = ns.areas + [area] -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}
                {%- endfor -%}

                {# --- 2. Renderizar Tabelas por Ãrea --- #}
                {%- if ns.areas | length == 0 -%}
                  <p style="text-align: center;">âš ï¸ <b>Nenhum sensor ou Ã¡rea detetada.</b></p>
                {%- else -%}
                  {%- for area in ns.areas | sort -%}
                    {# Verificar Filtro #}
                    {%- if filter in ['All Areas', 'Todas as Ãreas', 'unknown', 'unavailable', 'None'] or filter == area -%}

                      <h3>ğŸ“ {{ area }}</h3>
                      <table width="100%">
                      {%- for c in cats -%}
                        {%- set sensors = state_attr('sensor.hardware_sensors', c) -%}
                        {%- if sensors and sensors is iterable -%}
                          {%- for s in sensors -%}
                            {%- if s.get('area', 'Sem AtribuiÃ§Ã£o') == area -%}
                              <tr>
                                <td width="30px">
                                  <ha-icon icon="{{ 'mdi:lightning-bolt' if c == 'power' else 'mdi:counter' if c == 'energy' else 'mdi:thermometer' if c == 'temperature' else 'mdi:water-percent' if c == 'humidity' else 'mdi:brightness-5' if c == 'illuminance' else 'mdi:eye' }}" style="width: 20px; color: var(--secondary-text-color);"></ha-icon>
                                </td>
                                <td>{{ s.name }}</td>
                                <td align="right">
                                  {%- if c == 'occupancy' -%}
                                    {{ 'Ocupado ğŸ”´' if s.value == 'on' else 'Livre ğŸŸ¢' }}
                                  {%- else -%}
                                    <b>{{ s.value }}</b> <small>{{ s.unit }}</small>
                                  {%- endif -%}
                                </td>
                              </tr>
                            {%- endif -%}
                          {%- endfor -%}
                        {%- endif -%}
                      {%- endfor -%}
                      </table>
                      <hr style="border: 0; border-bottom: 1px solid var(--divider-color); margin: 15px 0;">

                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}

        # --- LEGENDA ---
        - type: markdown
          content: |
            ### ğŸ“˜ Guia RÃ¡pido
            {% set p = state_attr('sensor.hardware_sensors', 'power') %}
            {% set e = state_attr('sensor.hardware_sensors', 'energy') %}
            {% set l = state_attr('sensor.hardware_sensors', 'illuminance') %}
            {% set h = state_attr('sensor.hardware_sensors', 'humidity') %}

            {% if p and p | length > 0 %}
            **âš¡ PotÃªncia (Watts):** *O "VelocÃ­metro"*
            > Mostra quanta eletricidade estÃ¡ a usar **neste momento**.
            > *Dica:* Se este valor estiver alto, um aparelho "pesado" como o Forno ou AC estÃ¡ ligado.

            ---
            {% endif %}

            {% if e and e | length > 0 %}
            **ğŸ”‹ Energia (kWh):** *O "Contador"*
            > A quantidade total usada ao longo do tempo. Isto Ã© o que aparece na sua **Conta de Luz**.
            > *Escala:* **1 unidade (kWh)** equivale aproximadamente a uma carga completa de roupa.

            ---
            {% endif %}

            {% if l and l | length > 0 %}
            **ğŸ’¡ Luz (Lux):** *Luminosidade*
            > Mede o quÃ£o brilhante estÃ¡ a divisÃ£o.
            > *Escala:* **0** (Escuro Total) â†’ **150** (Sala TÃ­pica) â†’ **500+** (EscritÃ³rio Luminoso).

            ---
            {% endif %}

            {% if h and h | length > 0 %}
            **ğŸ’§ Humidade:** *Humidade do Ar*
            > **40-60%** Ã© a "Zona de Conforto."
            > *Aviso:* Acima de **70%** sente-se "abafado" e hÃ¡ risco de bolor; abaixo de **30%** sente-se muito seco.
            {% endif %}

# ========== TAB 2: DASHBOARD ==========
- title: Dashboard
  path: dashboard
  icon: mdi:chart-line
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: markdown
          content: |
            # ğŸ“Š Dashboard
            Analise os seus padrÃµes de consumo de energia e identifique oportunidades de poupanÃ§a.

        # --- SECÃ‡ÃƒO DE GRÃFICO ---
        - type: vertical-stack
          cards:
            - type: markdown
              content: |
                ### ğŸ“ˆ Desempenho vs. Baseline
                <div style="background: var(--card-background-color); border: 1px solid var(--divider-color); padding: 10px; border-radius: 6px; font-size: 13px; color: var(--secondary-text-color); margin-bottom: 0px;">
                  â„¹ï¸ <b>O que Ã© "Consumo Baseline"?</b><br>
                  Esta linha representa o seu consumo mÃ©dio de energia. SerÃ¡ ajustada ao longo do tempo.
                </div>

            - type: history-graph
              hours_to_show: 168
              entities:
                - entity: sensor.current_consumption
                  name: Uso Atual
                - entity: sensor.energy_baseline
                  name: Consumo Baseline

        # --- TABELA DE CONSUMO POR ÃREA ---
        - type: markdown
          content: |
            ### âš¡ Uso de Energia por Ãrea

            {%- set sensors = state_attr('sensor.hardware_sensors', 'power') -%}
            {%- set ns = namespace(area_sums={}, total=0) -%}

            {%- if sensors -%}
              {%- for s in sensors -%}
                {%- if s.value is not none -%}
                  {%- set ns.total = ns.total + s.value -%}
                  {%- set area = s.area if s.area else 'Sem Ãrea' -%}
                  {%- set current = ns.area_sums.get(area, 0) -%}
                  {%- set new_dict = {area: current + s.value} -%}
                  {%- set ns.area_sums = dict(ns.area_sums, **new_dict) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}

            {%- if ns.total == 0 -%}
            </br>
            ğŸ“­ Nenhum dado de Ã¡rea recolhido.
            {%- else -%}

            </br>

            <table width="100%">
              <thead>
                <tr>
                  <th style="text-align: left;">ğŸ“ Ãrea</th>
                  <th style="text-align: right;">âš¡ Uso</th>
                  <th style="text-align: right;">ğŸ“Š Quota</th>
                  <th style="text-align: left;">ğŸ“Š DistribuiÃ§Ã£o</th>
                </tr>
              </thead>
              <tbody>
              {%- for area, w in ns.area_sums.items() | sort(attribute='1', reverse=True) -%}
                {%- set pct = (w / ns.total * 100) | round(0) | int -%}
                {%- set blocks = (pct / 10) | round(0) | int -%}
                {%- set bar = 'â–ˆ' * blocks + 'â–‘' * (10 - blocks) -%}
                <tr>
                  <td style="text-align: left;"><b>{{ area }}</b></td>
                  <td style="text-align: right;">{{ w | round(2) }} W</td>
                  <td style="text-align: right;">{{ pct }}%</td>
                  <td style="text-align: left; color: var(--primary-color);">{{ bar }}</td>
                </tr>
              {%- endfor -%}
              </tbody>
            </table>
            {%- endif -%}

        # --- TOP 5 CONSUMIDORES ---
        - type: markdown
          content: |
            ### ğŸ† Top 5 Consumidores de Energia
            {%- set sensors = state_attr('sensor.hardware_sensors', 'power') -%}
            {%- if sensors -%}
            {%- set top_devices = sensors
                | selectattr('value', 'ne', None)
                | sort(attribute='value', reverse=True)
                | list
            -%}
            {%- set max_val = top_devices[0].value if (top_devices and top_devices[0].value > 0) else 1 -%}
            </br>
            <table width="100%">
              <thead>
                <tr>
                  <th style="text-align: left;">ğŸ”Œ Dispositivo</th>
                  <th style="text-align: right;">âš¡ Carga</th>
                  <th style="text-align: left; padding-left: 10px;">ğŸ“Š Impacto</th>
                </tr>
              </thead>
              <tbody>
                {%- for s in top_devices[:5] -%}
                {%- set pct = (s.value / max_val * 100) | int -%}
                {%- set blocks = (pct / 10) | round(0) | int -%}
                {%- set bar = 'â–ˆ' * blocks + 'â–‘' * (10 - blocks) -%}
                <tr>
                  <td style="text-align: left;">{{ s.name }}</td>
                  <td style="text-align: right;"><b>{{ s.value }} W</b></td>
                  <td style="text-align: left; padding-left: 10px; color: var(--primary-color);">
                    {{ bar }}
                  </td>
                </tr>
                {%- endfor -%}
              </tbody>
            </table>
            {%- else -%}
            </br>
            ğŸ˜´ Nenhum dispositivo ativo detetado.
            {%- endif -%}

# ========== TAB 3: DESAFIOS ==========
- title: Desafios
  path: tasks
  icon: mdi:clipboard-check
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: baseline
          card:
            type: markdown
            content: |
              ## ğŸ”’ Desafios Bloqueados
              **{{ state_attr('sensor.research_phase', 'days_remaining') }} dias** atÃ© desbloquear â³

        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: active
          card:
            type: vertical-stack
            cards:
              - type: markdown
                content: |
                  # ğŸ“… Desafios DiÃ¡rios de Energia
                  {% set verified = state_attr('sensor.daily_tasks', 'verified_count') | default(0) %}
                  {% set total = state_attr('sensor.daily_tasks', 'total_count') | default(0) %}
                  {% if total > 0 %}
                  âœ… **{{ verified }}/{{ total }}** tarefas verificadas hoje
                  {% else %}
                  ğŸ“­ Sem tarefas disponÃ­veis para hoje.
                  {% endif %}

              # --- BANNER DE SEQUÃŠNCIAS ---
              - type: horizontal-stack
                cards:
                  - type: markdown
                    content: |
                      {% set s = states('sensor.daily_task_streak') | int(0) %}
                      {% if s >= 7 %}
                      ## ğŸ”¥ {{ s }} dias
                      *ImparÃ¡vel!* â­
                      {% elif s >= 3 %}
                      ## ğŸ”¥ {{ s }} dias
                      *Continue assim!* ğŸ’ª
                      {% elif s == 1 %}
                      ## ğŸ”¥ 1 dia
                      *Bom comeÃ§o!* ğŸŒ±
                      {% else %}
                      ## ğŸ”¥ 0 dias
                      *Complete uma tarefa para comeÃ§ar!*
                      {% endif %}
                      <small>SequÃªncia de tarefas diÃ¡rias</small>
                  - type: markdown
                    content: |
                      {% set s = states('sensor.weekly_challenge_streak') | int(0) %}
                      {% if s >= 4 %}
                      ## ğŸ† {{ s }} semanas
                      *LendÃ¡rio!* ğŸŒŸ
                      {% elif s >= 2 %}
                      ## ğŸ† {{ s }} semanas
                      *Em forma!* ğŸ¯
                      {% elif s == 1 %}
                      ## ğŸ† 1 semana
                      *Primeira vitÃ³ria!* ğŸ‰
                      {% else %}
                      ## ğŸ† 0 semanas
                      *Ganhe esta semana para comeÃ§ar!*
                      {% endif %}
                      <small>SequÃªncia de desafios semanais</small>

              # Card Tarefa 1
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 0
                card:
                  type: vertical-stack
                  cards:
                    - type: horizontal-stack
                      cards:
                        - type: markdown
                          content: |
                            {% set tasks = state_attr('sensor.daily_tasks', 'tasks') %}
                            {% if tasks and tasks | length > 0 %}
                            {% set t = tasks[0] %}

                            ### {{ t.status_emoji }} Tarefa 1: {{ t.title }}

                            {{ t.description }}

                            **Meta:** {{ t.target_value }}{{ t.target_unit }} (de {{ t.baseline_value }}{{ t.target_unit }})
                            **ğŸ“Š Dificuldade:** {{ t.difficulty_display }}
                            {% if t.area_name %}**ğŸ“ Ãrea:** {{ t.area_name }}{% endif %}

                            {% if t.verified %}
                            âœ… **VERIFICADA!** Atingiu a meta!
                            {% else %}
                            ğŸ¯ **Ativa** - Complete hoje!
                            {% endif %}
                            {% endif %}

                    - type: horizontal-stack
                      cards:
                        - type: button
                          name: Muito FÃ¡cil
                          icon: mdi:emoticon-happy-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 0
                              feedback: too_easy
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Adequada
                          icon: mdi:emoticon-neutral-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 0
                              feedback: just_right
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Muito DifÃ­cil
                          icon: mdi:emoticon-sad-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 0
                              feedback: too_hard
                          entity: sensor.daily_tasks
                          show_state: false

              # Card Tarefa 2
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 1
                card:
                  type: vertical-stack
                  cards:
                    - type: horizontal-stack
                      cards:
                        - type: markdown
                          content: |
                            {% set tasks = state_attr('sensor.daily_tasks', 'tasks') %}
                            {% if tasks and tasks | length > 1 %}
                            {% set t = tasks[1] %}

                            ---

                            ### {{ t.status_emoji }} Tarefa 2: {{ t.title }}

                            {{ t.description }}

                            **ğŸ¯ Meta:** {{ t.target_value }}{{ t.target_unit }} (de {{ t.baseline_value }}{{ t.target_unit }})
                            **ğŸ“Š Dificuldade:** {{ t.difficulty_display }}
                            {% if t.area_name %}**ğŸ“ Ãrea:** {{ t.area_name }}{% endif %}

                            {% if t.verified %}
                            âœ… **VERIFICADA!** Atingiu a meta!
                            {% else %}
                            ğŸ¯ **Ativa** - Complete hoje!
                            {% endif %}
                            {% endif %}

                    - type: horizontal-stack
                      cards:
                        - type: button
                          name: Muito FÃ¡cil
                          icon: mdi:emoticon-happy-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 1
                              feedback: too_easy
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Adequada
                          icon: mdi:emoticon-neutral-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 1
                              feedback: just_right
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Muito DifÃ­cil
                          icon: mdi:emoticon-sad-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 1
                              feedback: too_hard
                          entity: sensor.daily_tasks
                          show_state: false

              # Card Tarefa 3
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 2
                card:
                  type: vertical-stack
                  cards:
                    - type: horizontal-stack
                      cards:
                        - type: markdown
                          content: |
                            {% set tasks = state_attr('sensor.daily_tasks', 'tasks') %}
                            {% if tasks and tasks | length > 2 %}
                            {% set t = tasks[2] %}

                            ---

                            ### {{ t.status_emoji }} Tarefa 3: {{ t.title }}

                            {{ t.description }}

                            **ğŸ¯ Meta:** {{ t.target_value }}{{ t.target_unit }} (de {{ t.baseline_value }}{{ t.target_unit }})
                            **ğŸ“Š Dificuldade:** {{ t.difficulty_display }}
                            {% if t.area_name %}**ğŸ“ Ãrea:** {{ t.area_name }}{% endif %}

                            {% if t.verified %}
                            âœ… **VERIFICADA!** Atingiu a meta!
                            {% else %}
                            ğŸ¯ **Ativa** - Complete hoje!
                            {% endif %}
                            {% endif %}

                    - type: horizontal-stack
                      cards:
                        - type: button
                          name: Muito FÃ¡cil
                          icon: mdi:emoticon-happy-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 2
                              feedback: too_easy
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Adequada
                          icon: mdi:emoticon-neutral-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 2
                              feedback: just_right
                          entity: sensor.daily_tasks
                          show_state: false

                        - type: button
                          name: Muito DifÃ­cil
                          icon: mdi:emoticon-sad-outline
                          icon_height: 30px
                          tap_action:
                            action: call-service
                            service: green_shift.submit_task_feedback
                            data:
                              task_index: 2
                              feedback: too_hard
                          entity: sensor.daily_tasks
                          show_state: false

              # BotÃ£o Verificar Todas as Tarefas
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 0
                card:
                  type: button
                  name: "Verificar Todas as Tarefas"
                  icon: mdi:check-circle
                  icon_height: 30px
                  tap_action:
                    action: call-service
                    service: green_shift.verify_tasks
                  show_state: false

              # Resumo
              - type: conditional
                conditions:
                  - condition: numeric_state
                    entity: sensor.daily_tasks
                    attribute: total_count
                    above: 0
                card:
                  type: markdown
                  content: |
                    ---
                    ### ğŸ’¡ Como Funciona o Feedback

                    Avalie a dificuldade de cada tarefa para ajudar o sistema a ajustar desafios futuros:
                    - **ğŸ˜Š Muito FÃ¡cil** â†’ PrÃ³xima vez serÃ¡ mais difÃ­cil
                    - **ğŸ˜ Adequada** â†’ Dificuldade mantÃ©m-se igual
                    - **ğŸ˜° Muito DifÃ­cil** â†’ PrÃ³xima vez serÃ¡ mais fÃ¡cil

                    â±ï¸ As tarefas sÃ£o verificadas de 15 em 15 minutos, mas tambÃ©m pode acionar manualmente a verificaÃ§Ã£o clicando no botÃ£o "Verificar Todas as Tarefas" para ver se completou alguma tarefa e obter feedback em tempo real!

# ========== TAB 4: META COLABORATIVA ==========
- title: Meta Colaborativa
  path: collaborative
  icon: mdi:account-group
  type: panel
  cards:
    - type: vertical-stack
      cards:
        # --- FASE DE CALIBRAÃ‡ÃƒO (BLOQUEADA) ---
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: baseline
          card:
            type: markdown
            content: |
              ## ğŸ”’ Meta Bloqueada

              ğŸ”§ O sistema estÃ¡ atualmente a aprender os hÃ¡bitos baseline do edifÃ­cio.

              **â³ Tempo Restante:** {{ state_attr('sensor.research_phase', 'days_remaining') }} dias

              *Assim que a calibraÃ§Ã£o estiver completa, os seus desafios semanais de energia aparecerÃ£o aqui.* ğŸ¯

        # --- FASE ATIVA (DESBLOQUEADA) ---
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: active
          card:
            type: vertical-stack
            cards:
              # CABEÃ‡ALHO DINÃ‚MICO & ESTADO
              - type: markdown
                content: |
                  # ğŸ¯ Desafio Semana {{ state_attr('sensor.weekly_challenge_progress', 'week_start') }}

                  {% set current = state_attr('sensor.weekly_challenge_progress', 'current_avg_w') | float(0) %}
                  {% set target = state_attr('sensor.weekly_challenge_progress', 'target_avg_w') | float(0) %}
                  {% set pct = state_attr('sensor.weekly_challenge_progress', 'progress') | float(0) %}

                  {% if pct <= 100 %}
                  ### Estado: âœ… No Caminho Certo ({{ pct }}%)
                  Continue assim! A equipa estÃ¡ abaixo do orÃ§amento de energia. ğŸ‰
                  {% else %}
                  ### Estado: âš ï¸ Em Risco ({{ pct }}%)
                  AÃ§Ã£o necessÃ¡ria! Estamos a exceder a mÃ©dia alvo. ğŸš¨
                  {% endif %}

              # INDICADOR & MOTIVAÃ‡ÃƒO
              - type: horizontal-stack
                cards:
                  # Indicador da Meta
                  - type: gauge
                    entity: sensor.weekly_challenge_progress
                    name: OrÃ§amento Usado
                    min: 0
                    max: 150
                    unit: "%"
                    severity:
                      green: 0
                      yellow: 90
                      red: 105

                  # Incentivo MonetÃ¡rio Calculado
                  - type: markdown
                    content: |
                      ### ğŸ† A Recompensa

                      {% set baseline = state_attr('sensor.weekly_challenge_progress', 'baseline_w') | float(0) %}
                      {% set target = state_attr('sensor.weekly_challenge_progress', 'target_avg_w') | float(0) %}
                      {% set price = states('input_number.electricity_price') | float(0.25) %}
                      {% set currency = states('input_select.currency') %}

                      {# Calcular PoupanÃ§as Semanais Potenciais: (Watts Poupados * 24h * 7d / 1000) * PreÃ§o #}
                      {% set potential_watts = baseline - target %}
                      {% set potential_eur = (potential_watts * 24 * 7 / 1000 * price) | round(2) %}

                      Se atingir esta meta, poderÃ¡ poupar esta semana aproximadamente:

                      # ğŸ’° {{ potential_eur }} {{ currency }}

                      *comparado com a sua semana baseline padrÃ£o.*

              # BARRA DE ESTATÃSTICAS
              - type: entities
                show_header_toggle: false
                entities:
                  - type: attribute
                    entity: sensor.weekly_challenge_progress
                    attribute: current_avg_w
                    name: Carga MÃ©dia Atual
                    icon: mdi:flash
                    suffix: "W"
                  - type: attribute
                    entity: sensor.weekly_challenge_progress
                    attribute: target_avg_w
                    name: Carga MÃ©dia Alvo
                    icon: mdi:target
                    suffix: "W"

              # ÃREAS DE FOCO AO VIVO
              - type: markdown
                content: |
                  ### ğŸ•µï¸â€â™‚ï¸ Ãreas de Foco ao Vivo
                  *Onde a equipa pode ajudar agora?* ğŸ¤”

                  {%- set sensors = state_attr('sensor.hardware_sensors', 'power') -%}
                  {%- set ns = namespace(area_sums={}, total=0) -%}

                  {# Agregar PotÃªncia por Ãrea (Incluindo Ã¡reas 0W para cÃ¡lculo preciso) #}
                  {%- if sensors -%}
                    {%- for s in sensors -%}
                      {%- if s.value is not none -%}
                        {%- set area = s.area if s.area else 'Outro' -%}
                        {%- set current = ns.area_sums.get(area, 0) -%}
                        {%- set ns.area_sums = dict(ns.area_sums, **{area: current + s.value}) -%}
                        {%- set ns.total = ns.total + s.value -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}

                  {# Calcular mÃ©dia entre TODAS as Ã¡reas monitorizadas #}
                  {%- set area_count = ns.area_sums | length -%}
                  {%- set mean = (ns.total / area_count) if area_count > 0 else 0 -%}
                  
                  {# Limiares dinÃ¢micos com um mÃ­nimo absoluto (ex: 200W / 50W) #}
                  {%- set high_threshold = [mean * 1.5, 200] | max -%}
                  {%- set moderate_threshold = [mean * 0.7, 50] | max -%}

                  <table width="100%">
                  <thead>
                    <tr>
                      <th align="left">ğŸ“ Ãrea</th>
                      <th align="right">âš¡ Carga Atual</th>
                      <th align="center">ğŸ“Š Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                  {%- for area, watts in ns.area_sums.items() | sort(attribute='1', reverse=True) -%}
                    {# Mostrar apenas Ã¡reas com uso acionÃ¡vel (ex: > 10W) #}
                    {%- if watts > 10 -%}
                    <tr>
                      <td><b>{{ area }}</b></td>
                      <td align="right">{{ watts | int }} W</td>
                      <td align="center">{% if watts > high_threshold %}ğŸ”´ Alto{% elif watts > moderate_threshold %}ğŸŸ  Moderado{% else %}ğŸŸ¢ Baixo{% endif %}</td>
                    </tr>
                    {%- endif -%}
                  {%- endfor -%}
                  </tbody>
                  </table>

                  <small><i>ğŸ’¡ Verifique as Ã¡reas com uso "Alto" para ver se pode desligar luzes ou dispositivos!</i></small>

# ========== TAB 5: NOTIFICAÃ‡Ã•ES ==========
- title: NotificaÃ§Ãµes
  path: notifications
  icon: mdi:bell
  type: panel
  cards:
    - type: vertical-stack
      cards:

        # --- ESTADO BLOQUEADO (BASELINE) ---
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: baseline
          card:
            type: markdown
            content: |
              ## ğŸ”’ NotificaÃ§Ãµes Bloqueadas

              Estamos atualmente a aprender os seus hÃ¡bitos baseline.
              Alertas inteligentes e nudges serÃ£o ativados em **{{ state_attr('sensor.research_phase', 'days_remaining') }} dias**. â³

        # --- ESTADO ATIVO (UI COMPLETA) ---
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: active
          card:
            type: vertical-stack
            cards:
              # --- SECÃ‡ÃƒO SUPERIOR (ESTATÃSTICAS & INSTRUÃ‡Ã•ES) ---
              - type: tile
                entity: sensor.active_notifications
                name: Alertas Ativos
                icon: mdi:bell-ring
                color: accent

              - type: markdown
                content: |
                  ### â„¹ï¸ Como Usar
                  1. **ğŸ“– Leia** os detalhes do alerta abaixo.
                  2. **ğŸƒ Aja** para verificar ou corrigir o problema em sua casa.
                  3. **ğŸ”½ Selecione** o ID no painel.
                  4. **ğŸ‘† Toque** em Aceitar ou Rejeitar apenas *depois* de ter agido.

              # --- SECÃ‡ÃƒO INBOX ---
              - type: markdown
                title: ğŸ“¬ Inbox Pendente
                content: |
                  {%- set notifs = state_attr('sensor.active_notifications', 'notifications') -%}
                  {%- set safe_notifs = notifs if notifs else [] -%}
                  {%- set pending = safe_notifs | selectattr('responded', 'equalto', false) | list -%}

                  {%- if pending | length == 0 -%}
                  ### âœ… Tudo em Dia!
                  Sem alertas pendentes no momento. ğŸ˜
                  {%- else -%}

                  {%- for n in pending -%}
                  ---
                  ### ğŸ“¢ {{ n.title }}
                  **ID:** `{{ n.notification_id }}` â€¢ **â° Tempo:** *{{ n.time_ago }}*

                  {{ n.message }}

                  {%- endfor -%}
                  {%- endif -%}

              # --- PAINEL DE AÃ‡ÃƒO ---
              - type: vertical-stack
                cards:
                  - type: entities
                    title: ğŸ¬ Tomar AÃ§Ã£o
                    show_header_toggle: false
                    entities:
                      - entity: select.notification_selector
                        name: ğŸ”½ Selecione o ID para Responder

                  - type: horizontal-stack
                    cards:
                      - type: tile
                        entity: select.notification_selector
                        name: Aceitar
                        icon: mdi:check
                        color: green
                        show_entity_picture: false
                        state_content: []
                        tap_action:
                          action: call-service
                          service: green_shift.respond_to_selection
                          data:
                            decision: accept

                      - type: tile
                        entity: select.notification_selector
                        name: Rejeitar
                        icon: mdi:close
                        color: red
                        show_entity_picture: false
                        state_content: []
                        tap_action:
                          action: call-service
                          service: green_shift.respond_to_selection
                          data:
                            decision: reject

              # --- TABELA HISTÃ“RICO ---
              - type: markdown
                title: ğŸ“œ HistÃ³rico
                content: |
                  {%- set ns = state_attr('sensor.active_notifications', 'notifications') -%}
                  {%- if ns -%}
                  <table width="100%">
                    <thead>
                      <tr>
                        <th align="left">â° Tempo</th>
                        <th align="left">ğŸ“‹ Tipo</th>
                        <th align="center">ğŸ“Š Estado</th>
                      </tr>
                    </thead>
                    <tbody>
                    {%- for n in ns[:8] -%}
                      <tr>
                        <td>{{ n.time_ago }}</td>
                        <td>{{ n.action_type | replace('_', ' ') | capitalize }}</td>
                        <td align="center">{{ n.status_emoji }}</td>
                      </tr>
                    {%- endfor -%}
                    </tbody>
                  </table>
                  {%- else -%}
                  ğŸ“­ Sem histÃ³rico disponÃ­vel.
                  {%- endif -%}

# ========== TAB 6: PERFIL ==========
- title: Perfil
  path: profile
  icon: mdi:account-circle
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: baseline
          card:
            type: markdown
            content: |
              ## ğŸš§ Perfil em ConstruÃ§Ã£o...
              ğŸ”§ Estamos atualmente a calibrar o seu baseline.
              As suas estatÃ­sticas ecolÃ³gicas pessoais e nÃ­veis serÃ£o desbloqueados em **{{ state_attr('sensor.research_phase', 'days_remaining') }} dias**. â³

        - type: conditional
          conditions:
            - entity: sensor.research_phase
              state: active
          card:
            type: vertical-stack
            cards:
              # --- CARD NÃVEL DO JOGADOR ---
              - type: markdown
                content: |
                  {% set tasks = states('sensor.tasks_completed_today') | int %}
                  {% if tasks < 5 %}
                  # ğŸ£ NÃ­vel 1: Principiante
                  *Complete mais tarefas diÃ¡rias para evoluir!* ğŸŒ±
                  {% elif tasks < 15 %}
                  # ğŸŒ¿ NÃ­vel 2: Aprendiz EcolÃ³gico
                  *EstÃ¡ a perceber o sistema!* ğŸ’ª
                  {% elif tasks < 30 %}
                  # ğŸŒ³ NÃ­vel 3: GuardiÃ£o
                  *DedicaÃ§Ã£o incrÃ­vel!* â­
                  {% else %}
                  # ğŸ‘‘ NÃ­vel 4: Mestre PlanetÃ¡rio
                  *Ã‰ uma lenda da poupanÃ§a de energia.* ğŸ†
                  {% endif %}

                  ---
                  **ğŸ“Š Tarefas Completadas (Ãšltimos 30 Dias):** {{ tasks }}
                  <small>*O seu nÃ­vel baseia-se nas tarefas completadas nos Ãºltimos 30 dias*</small>

              # --- SEQUÃŠNCIAS ---
              - type: markdown
                content: |
                  ### ğŸ”¥ As Suas SequÃªncias
                  {% set daily = states('sensor.daily_task_streak') | int(0) %}
                  {% set weekly = states('sensor.weekly_challenge_streak') | int(0) %}

                  | | SequÃªncia | Estado |
                  |---|---|---|
                  | ğŸ”¥ Tarefas DiÃ¡rias | **{{ daily }} dia{% if daily != 1 %}s{% endif %}** | {{ 'â­ ImparÃ¡vel!' if daily >= 7 else ('ğŸ’ª A crescer!' if daily >= 3 else ('ğŸŒ± Bom comeÃ§o!' if daily >= 1 else 'â–¶ï¸ Complete uma tarefa!')) }} |
                  | ğŸ† Metas Semanais | **{{ weekly }} semana{% if weekly != 1 %}s{% endif %}** | {{ 'ğŸŒŸ LendÃ¡rio!' if weekly >= 4 else ('ğŸ¯ Em forma!' if weekly >= 2 else ('ğŸ‰ Primeira vitÃ³ria!' if weekly >= 1 else 'ğŸ¯ Ganhe esta semana!')) }} |

              - type: horizontal-stack
                cards:
                  - type: gauge
                    entity: sensor.behavior_index
                    name: ğŸ’ª Compromisso
                    min: 0
                    max: 1
                    severity:
                      red: 0
                      yellow: 0.4
                      green: 0.8

                  - type: gauge
                    entity: sensor.fatigue_index
                    name: ğŸ˜´ Risco de Fadiga
                    min: 0
                    max: 1
                    severity:
                      green: 0
                      yellow: 0.5
                      red: 0.8

              # --- RESUMO DE IMPACTO TOTAL ---
              - type: glance
                title: ğŸŒŸ Impacto Total
                columns: 3
                entities:
                  - entity: sensor.accumulated_savings
                    name: ğŸ’° Dinheiro Poupado
                  - entity: sensor.co2_saved
                    name: ğŸŒ± COâ‚‚ Evitado
                  - entity: sensor.weekly_challenge_progress
                    name: ğŸ¯ Meta Atual

              # --- CONTEXTO "SABIA QUE?" ---
              - type: markdown
                content: |
                  ### ğŸŒ O Seu Impacto no Mundo Real
                  {% set trees = state_attr('sensor.co2_saved', 'trees') | default(0) %}
                  {% set flights = state_attr('sensor.co2_saved', 'flights') | default(0) %}
                  {% set km = state_attr('sensor.co2_saved', 'car_km') | default(0) %}

                  As suas poupanÃ§as atÃ© agora equivalem a:
                  * ğŸŒ² Plantar **{{ trees }} Ã¡rvores maduras**
                  * âœˆï¸ Compensar **{{ flights }} voos de curta distÃ¢ncia**
                  * ğŸš— Evitar **{{ km }} km** conduzidos num carro a gasolina

# ========== TAB 7: DEFINIÃ‡Ã•ES ==========
- title: DefiniÃ§Ãµes
  path: settings
  icon: mdi:cog
  type: panel
  cards:
    - type: vertical-stack
      cards:
        - type: markdown
          content: |
            # âš™ï¸ ConfiguraÃ§Ã£o do Sistema
            Gerir as suas preferÃªncias, configuraÃ§Ãµes de custos e ver a saÃºde do sistema. ğŸ”§

        # --- ESTADO DO SISTEMA (Apenas Leitura) ---
        - type: entities
          title: ğŸ“Š Estado do Sistema
          show_header_toggle: false
          state_color: true
          entities:
            - entity: sensor.research_phase
              name: Fase Atual
              icon: mdi:flask-outline
              secondary_info: last-updated

            - entity: sensor.energy_baseline
              name: Baseline Aprendida
              icon: mdi:chart-bell-curve-cumulative

        # --- CONFIGURAÃ‡ÃƒO (Inputs de Utilizador) ---
        - type: entities
          title: ğŸ›ï¸ PreferÃªncias & Custos
          show_header_toggle: false
          entities:
            # --- SECÃ‡ÃƒO: METAS ---
            - type: section
              label: "Metas de Energia"

            - type: conditional
              conditions:
                - entity: sensor.research_phase
                  state: baseline
              row:
                type: attribute
                entity: sensor.research_phase
                attribute: days_remaining
                name: "Metas Bloqueadas (CalibraÃ§Ã£o)"
                icon: mdi:lock-clock
                suffix: "dias restantes"

            - type: conditional
              conditions:
                - entity: sensor.research_phase
                  state: active
              row:
                entity: input_number.energy_saving_target
                name: "Meta de ReduÃ§Ã£o Semanal (%)"
                icon: mdi:target

            # --- SECÃ‡ÃƒO: ECONÃ“MICA ---
            - type: section
              label: "Custos & Moeda"

            - entity: input_select.currency
              name: ğŸ’µ Moeda
              icon: mdi:cash-100

            - entity: input_number.electricity_price
              name: PreÃ§o da Eletricidade (por kWh)
              icon: mdi:lightning-bolt-circle

        # --- RODAPÃ‰ DE AJUDA ---
        - type: markdown
          content: |
            ### â„¹ï¸ Guia RÃ¡pido
            * **ğŸ”¬ Fase Baseline:** O sistema aprende o seu uso normal durante 14 dias.
            * **ğŸ“‰ Meta de ReduÃ§Ã£o:** Uma vez ativo, o sistema definirÃ¡ desafios semanais para reduzir o seu consumo nesta percentagem.
            * **ğŸ’¡ Dicas:** Ajuste as configuraÃ§Ãµes com base nos seus objetivos energÃ©ticos e tarifas locais de eletricidade.
